<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Commons MariaDB API &#8212; Database Release Manager</title>
    
    <link rel="stylesheet" href="static/basic.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/dbrm.css" type="text/css" />
    <link rel="stylesheet" href="static/bootswatch-3.3.6/superhero/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Commons Oracle API" href="commons_oracle.html" />
    <link rel="prev" title="Psql API" href="psql.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Database Release Manager</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="dbm.html">Dbm Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="logfile.html">Logfile Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="mariadb.html">MariaDB Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongo.html">Mongo Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="common.html">Commons API</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql.html">Mysql API</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqlplus.html">Sqlplus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="psql.html">Psql API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Commons Mariadb API</a></li>
<li class="toctree-l1"><a class="reference internal" href="commons_oracle.html">Commons Oracle API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Commons MariaDB API</a><ul>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#commons-mariadb-check-client">commons_mariadb_check_client</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-vars">commons_mariadb_check_vars</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-connection">commons_mariadb_check_connection</a></li>
<li><a class="reference internal" href="#commons-mariadb-shell">commons_mariadb_shell</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-file">commons_mariadb_compile_file</a></li>
<li><a class="reference internal" href="#commons-mariadb-source-file">commons_mariadb_source_file</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-fkey">commons_mariadb_compile_fkey</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-idx">commons_mariadb_compile_idx</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-procedures">commons_mariadb_compile_all_procedures</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-triggers">commons_mariadb_compile_all_triggers</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-functions">commons_mariadb_compile_all_functions</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-views">commons_mariadb_compile_all_views</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-fkeys">commons_mariadb_compile_all_fkeys</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-idxs">commons_mariadb_compile_all_idxs</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-events">commons_mariadb_compile_all_events</a></li>
<li><a class="reference internal" href="#commons-mariadb-compile-all-from-dir">commons_mariadb_compile_all_from_dir</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-fkeys">commons_mariadb_count_fkeys</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-procedures">commons_mariadb_count_procedures</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-functions">commons_mariadb_count_functions</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-triggers">commons_mariadb_count_triggers</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-views">commons_mariadb_count_views</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-events">commons_mariadb_count_events</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-indexes">commons_mariadb_count_indexes</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-procedure">commons_mariadb_check_if_exist_procedure</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-function">commons_mariadb_check_if_exist_function</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-view">commons_mariadb_check_if_exist_view</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-fkey">commons_mariadb_check_if_exist_fkey</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-index">commons_mariadb_check_if_exist_index</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-triggers-list">commons_mariadb_get_triggers_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-count-tables">commons_mariadb_count_tables</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-fkeys-list">commons_mariadb_get_fkeys_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-indexes-list">commons_mariadb_get_indexes_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-tables-list">commons_mariadb_get_tables_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-desc-table">commons_mariadb_desc_table</a></li>
<li><a class="reference internal" href="#commons-mariadb-exist-table">commons_mariadb_exist_table</a></li>
<li><a class="reference internal" href="#commons-mariadb-exist-event">commons_mariadb_exist_event</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-procedures-list">commons_mariadb_get_procedures_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-functions-list">commons_mariadb_get_functions_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-events-list">commons_mariadb_get_events_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-views-list">commons_mariadb_get_views_list</a></li>
<li><a class="reference internal" href="#commons-mariadb-check-if-exist-trigger">commons_mariadb_check_if_exist_trigger</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-procedure">commons_mariadb_download_procedure</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-function">commons_mariadb_download_function</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-trigger">commons_mariadb_download_trigger</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-event">commons_mariadb_download_event</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-view">commons_mariadb_download_view</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-views">commons_mariadb_download_all_views</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-procedures">commons_mariadb_download_all_procedures</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-functions">commons_mariadb_download_all_functions</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-triggers">commons_mariadb_download_all_triggers</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-events">commons_mariadb_download_all_events</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-fkey">commons_mariadb_download_fkey</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-fkeys">commons_mariadb_download_all_fkeys</a></li>
<li><a class="reference internal" href="#commons-mariadb-drop-fkey">commons_mariadb_drop_fkey</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-index">commons_mariadb_download_index</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-indexes">commons_mariadb_download_all_indexes</a></li>
<li><a class="reference internal" href="#commons-mariadb-drop-index">commons_mariadb_drop_index</a></li>
<li><a class="reference internal" href="#commons-mariadb-create-fkey-file">commons_mariadb_create_fkey_file</a></li>
<li><a class="reference internal" href="#commons-mariadb-create-fkey-file">commons_mariadb_create_fkey_file</a></li>
<li><a class="reference internal" href="#commons-mariadb-get-table-def">commons_mariadb_get_table_def</a></li>
<li><a class="reference internal" href="#commons-mariadb-download-all-tables">commons_mariadb_download_all_tables</a></li>
<li><a class="reference internal" href="#commons-mariadb-drop-trigger">commons_mariadb_drop_trigger</a></li>
<li><a class="reference internal" href="#commons-mariadb-drop-event">commons_mariadb_drop_event</a></li>
<li><a class="reference internal" href="#commons-mariadb-show-gvars">commons_mariadb_show_gvars</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="psql.html" title="Previous Chapter: Psql API"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Psql API</span>
    </a>
  </li>
  <li>
    <a href="commons_oracle.html" title="Next Chapter: Commons Oracle API"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Commons Oracl... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row" >
    <div class="col-md-12 content">
      
  <div class="section" id="commons-mariadb-api">
<span id="commons-mariadb-api"></span><h1>Commons MariaDB API<a class="headerlink" href="#commons-mariadb-api" title="Permalink to this headline">¶</a></h1>
<p>A list of functions used with <code class="docutils literal"><span class="pre">mysql</span></code> client tool to retrieve data from Mysql/MariaDB server.</p>
<div class="section" id="api">
<span id="api"></span><h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="commons-mariadb-check-client">
<span id="commons-mariadb-check-client"></span><h3>commons_mariadb_check_client<a class="headerlink" href="#commons-mariadb-check-client" title="Permalink to this headline">¶</a></h3>
<p>Check if mysql client program is present on system.
If present MARIADB_CLIENT variable with abs path is set.
Function check if it is set <code class="docutils literal"><span class="pre">mysql</span></code> variable:</p>
<ul class="simple">
<li>if it is not set then try to find path through &#8216;which&#8217; program</li>
<li>if it is set then check if path is correct and program exists.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock11'))">(Show/Hide)</a><br /><div id="hiddencodeblock11" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_client <span class="o">()</span> <span class="o">{</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mysql</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="c1"># POST: mysql variable not set</span>
    <span class="nv">tmp</span><span class="o">=</span><span class="sb">`</span>which mysql 2&gt; /dev/null<span class="sb">`</span>
    <span class="nv">var</span><span class="o">=</span><span class="nv">$?</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$var</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Use mysql: </span><span class="nv">$tmp</span><span class="s2">\n&quot;</span>

      <span class="nv">MARIADB_CLIENT</span><span class="o">=</span><span class="nv">$tmp</span>

      <span class="nb">unset</span> tmp

    <span class="k">else</span>

      error_generate <span class="s2">&quot;mysql program not found&quot;</span>

      <span class="k">return</span> 1

    <span class="k">fi</span>

  <span class="k">else</span>

    <span class="c1"># POST: mysql variable set</span>

    <span class="c1"># Check if file is correct</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$mysql</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Use mysql: </span><span class="nv">$mysql</span><span class="s2">\n&quot;</span>

      <span class="nv">MARIADB_CLIENT</span><span class="o">=</span><span class="nv">$mysql</span>

    <span class="k">else</span>

      error_generate <span class="s2">&quot;</span><span class="nv">$mysql</span><span class="s2"> program invalid.&quot;</span>

      <span class="k">return</span> 1

    <span class="k">fi</span>

  <span class="k">fi</span>

  <span class="nb">export</span> MARIADB_CLIENT

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-vars">
<span id="commons-mariadb-check-vars"></span><h3>commons_mariadb_check_vars<a class="headerlink" href="#commons-mariadb-check-vars" title="Permalink to this headline">¶</a></h3>
<p>Check if are present mandatary mariadb environment variables:</p>
<ul class="simple">
<li>MARIADB_USER</li>
<li>MARIADB_PWD</li>
<li>MARIADB_DB</li>
<li>MARIADB_DIR</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: all mandatory variables are present.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error (program is interrupter with exit 1 command)</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock12'))">(Show/Hide)</a><br /><div id="hiddencodeblock12" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_vars <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">commons_msg</span><span class="o">=</span><span class="s1">&#39;variable on configuration file, through arguments or on current profile.&#39;</span>

  check_var <span class="s2">&quot;MARIADB_USER&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;You must define MARIADB_USER </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MARIADB_PWD&quot;</span>  <span class="o">||</span> error_handled <span class="s2">&quot;You must define MARIADB_PWD </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MARIADB_DB&quot;</span>   <span class="o">||</span> error_handled <span class="s2">&quot;You must define MARIADB_DB </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MARIADB_DIR&quot;</span>  <span class="o">||</span> error_handled <span class="s2">&quot;You must define MARIADB_DIR </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>


  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-connection">
<span id="commons-mariadb-check-connection"></span><h3>commons_mariadb_check_connection<a class="headerlink" href="#commons-mariadb-check-connection" title="Permalink to this headline">¶</a></h3>
<p>Check connection to database.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: when connection is ok.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock13'))">(Show/Hide)</a><br /><div id="hiddencodeblock13" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_connection <span class="o">()</span> <span class="o">{</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MARIADB_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mysql_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_check_connection) Try connection with -A </span><span class="nv">$MARIADB_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mysql_auth</span><span class="s2">.\n&quot;</span>

  <span class="nv">$MARIADB_CLIENT</span> -A <span class="nv">$MARIADB_EXTRA_OPTIONS</span> <span class="nv">$mysql_auth</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="s">&lt;&lt; EOF</span>
<span class="s">exit</span>
<span class="s">EOF</span>

  <span class="nv">errorCode</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">errorCode</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="nb">unset</span> errorCode

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;mysql was connected successfully&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-shell">
<span id="commons-mariadb-shell"></span><h3>commons_mariadb_shell<a class="headerlink" href="#commons-mariadb-shell" title="Permalink to this headline">¶</a></h3>
<p>Enter on command line shell of Mysql/Mariadb server.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock14'))">(Show/Hide)</a><br /><div id="hiddencodeblock14" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_shell <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MARIADB_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mysql_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$MARIADB_ENABLE_COMMENTS</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="nv">$MARIADB_ENABLE_COMMENTS</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$opts</span><span class="s2"> -c&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># TODO: Enable -A options through a variable option.</span>
  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_shell) Try connection with </span><span class="nv">$opts</span><span class="s2"> </span><span class="nv">$MARIADB_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mysql_auth</span><span class="s2">.\n&quot;</span>

  <span class="nv">$MARIADB_CLIENT</span> <span class="nv">$opts</span> <span class="nv">$MARIADB_EXTRA_OPTIONS</span> <span class="nv">$mysql_auth</span>

  <span class="nv">errorCode</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">errorCode</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="nb">unset</span> errorCode

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-file">
<span id="commons-mariadb-compile-file"></span><h3>commons_mariadb_compile_file<a class="headerlink" href="#commons-mariadb-compile-file" title="Permalink to this headline">¶</a></h3>
<p>Compile file on database.
Output of the compilation is saved on <code class="docutils literal"><span class="pre">MYSQL_OUTPUT</span></code> variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) path of the file to compile</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to insert on logging file relative to input file</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock15'))">(Show/Hide)</a><br /><div id="hiddencodeblock15" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$f</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    _logfile_write <span class="s2">&quot;(mariadb) File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">return</span> 1
  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start compilation (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> <span class="s2">&quot;(mariadb) Start compilation (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span>

  <span class="nv">MYSQL_OUTPUT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  mysql_file <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

  _logfile_write <span class="s2">&quot;\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  _logfile_write <span class="s2">&quot;(mariadb) End compilation (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> -en <span class="s2">&quot;(mariadb) End compilation (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">\n&quot;</span>

  <span class="k">return</span> <span class="nv">$ans</span>

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-source-file">
<span id="commons-mariadb-source-file"></span><h3>commons_mariadb_source_file<a class="headerlink" href="#commons-mariadb-source-file" title="Permalink to this headline">¶</a></h3>
<p>Compile file on database (with source command).
Output of the compilation is saved on <code class="docutils literal"><span class="pre">MYSQL_OUTPUT</span></code> variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) path of the file to compile</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to insert on logging file relative to input file</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock16'))">(Show/Hide)</a><br /><div id="hiddencodeblock16" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_source_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$f</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    _logfile_write <span class="s2">&quot;(mariadb) File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">return</span> 1
  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start compilation/source (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> <span class="s2">&quot;(mariadb) Start compilation/source (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span>

  <span class="nv">MYSQL_OUTPUT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  mysql_source_file <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

  _logfile_write <span class="s2">&quot;\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  _logfile_write <span class="s2">&quot;(mariadb) End compilation/source (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> -en <span class="s2">&quot;(mariadb) End compilation/source (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">\n&quot;</span>

  <span class="k">return</span> <span class="nv">$ans</span>

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-fkey">
<span id="commons-mariadb-compile-fkey"></span><h3>commons_mariadb_compile_fkey<a class="headerlink" href="#commons-mariadb-compile-fkey" title="Permalink to this headline">¶</a></h3>
<p>Compile file related with foreign key on database.
Output of the compilation is saved on <code class="docutils literal"><span class="pre">MYSQL_OUTPUT</span></code> variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) path of the file to compile</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to insert on logging file relative to input file</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (force) If foreign key is present and force argument is equal to 1,
then foreign key is dropped and added again.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (fk_table) table of the foreign key</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock17'))">(Show/Hide)</a><br /><div id="hiddencodeblock17" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_fkey <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_table</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">fk_dir</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">fk_str</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">f_base</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">fk</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">fktname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="c1"># Try to check if is present table name from filename</span>
  <span class="nv">fktname</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$fk_str</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[a-zA-Z_]+/) { print substr($0, RSTART, RLENGTH) }&#39;</span><span class="k">)</span>
  <span class="nv">fk</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$fk_str</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[-]/) { print substr($0, RSTART + 1) }&#39;</span><span class="k">)</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mariadb_compile_fkey: f = </span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">, force = </span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">, fk_table&quot;</span><span class="se">\</span>
    <span class="s2">&quot; = </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">, fktname = </span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">, fk = </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">, fk_str = </span><span class="si">${</span><span class="nv">fk_str</span><span class="si">}</span><span class="s2">.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">fk_table</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># POST: fk_str contains both fk key name and fk key table.</span>
    <span class="c1">#       I check if fk_table in input is equal to fktname (string catch from fr_str)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;(mariadb) Foreign key </span><span class="si">${</span><span class="nv">fk_str</span><span class="si">}</span><span class="s2"> is not related with table </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

      error_generate <span class="s2">&quot;Foreign key </span><span class="si">${</span><span class="nv">fk_str</span><span class="si">}</span><span class="s2"> is not related with table </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">fi</span>

  <span class="k">fi</span>

  <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">fk</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_str</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># Check if foreign key already present</span>
  commons_mariadb_check_if_exist_fkey <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">fk_is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="c1"># If fktname is empty and fk_table is not available and foreign key is present</span>
  <span class="c1"># I try to retrieve table name</span>
  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$fk_is_present</span> -eq <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_fkeys_list <span class="s2">&quot;&quot;</span> <span class="s2">&quot;KCU.CONSTRAINT_NAME, KCU.TABLE_NAME&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on get data of foreign key </span><span class="nv">$fk</span><span class="s2">.&quot;</span>

    <span class="nv">fk_table</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;( commons_mariadb_compile_fkey: (</span><span class="si">${</span><span class="nv">fk_str</span><span class="si">}</span><span class="s2">) I use fkey </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">) (force = </span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">))\n&quot;</span>

  <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">f</span><span class="o">=</span><span class="si">${</span><span class="nv">fk_dir</span><span class="si">}</span>/<span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span>-<span class="si">${</span><span class="nv">fk</span><span class="si">}</span>.sql

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    _logfile_write <span class="s2">&quot;(mariadb) File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(mariadb) File </span><span class="nv">$f</span><span class="s2"> not found.\n&quot;</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;( commons_mariadb_compile_fkey: Try to compile foreign key </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">)...)\n&quot;</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$fk_is_present</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># POST: foreign is is present and force is equal to 1.</span>

    commons_mariadb_drop_fkey <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

    commons_mariadb_compile_file <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">elif</span> <span class="o">[</span> <span class="nv">$fk_is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      <span class="nb">echo</span> -en <span class="s2">&quot;( commons_mariadb_compile_fkey: foreign key </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">fk_table</span><span class="si">}</span><span class="s2"> is already present. Nothing to do.)\n&quot;</span>

    _logfile_write <span class="s2">&quot;(mariadb) Foreign key </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> is already present. Nothing to do.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">elif</span> <span class="o">[</span> <span class="nv">$fk_is_present</span> -eq <span class="m">2</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      <span class="nb">echo</span> -en <span class="s2">&quot;( commons_mariadb_compile_fkey: foreign key </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> exists for different tables.\nSet table param.)\n&quot;</span>

    _logfile_write <span class="s2">&quot;(mariadb) Foreign key </span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2"> exists for different tables. Set table param for compilation.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="c1"># POST: foreign key not present. I compile it.</span>
    commons_mariadb_compile_file <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-idx">
<span id="commons-mariadb-compile-idx"></span><h3>commons_mariadb_compile_idx<a class="headerlink" href="#commons-mariadb-compile-idx" title="Permalink to this headline">¶</a></h3>
<p>Compile file related with index of a table to database.
Output of the compilation is saved on <code class="docutils literal"><span class="pre">MYSQL_OUTPUT</span></code> variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) path of the file to compile</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to insert on logging file relative to input file</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (force) if index is present and force is equal to 1, then
index is dropped and added again.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (idx_table) table of the index</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock18'))">(Show/Hide)</a><br /><div id="hiddencodeblock18" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_idx <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">idx_table</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">idx_dir</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">idx_str</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">f_base</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">idx</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">idx_is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">idxtname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="c1"># Try to check if is present table name from filename</span>
  <span class="c1"># TODO: show how handle table with &quot;-&quot; on name.</span>
  <span class="nv">idxtname</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$idx_str</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[a-zA-Z_]+/) { print substr($0, RSTART, RLENGTH) }&#39;</span><span class="k">)</span>
  <span class="nv">idx</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$idx_str</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[-]/) { print substr($0, RSTART + 1) }&#39;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idxtname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">idx_table</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">idxtname</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># POST: idx_str contains both index name and index table.</span>
    <span class="c1">#       I check if idx_table in input is equal to idxtname (string catch from idx_str)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idxtname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;(mariadb) Index </span><span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span><span class="s2"> is not related with table </span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

      error_generate <span class="s2">&quot;Index </span><span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span><span class="s2"> is not related with table </span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">fi</span>

  <span class="k">fi</span>

  <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">idx</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># Check if foreign key already present</span>
  commons_mariadb_check_if_exist_index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">idx_is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="c1"># If idxtname is empty and idx_table is not available and index is present</span>
  <span class="c1"># I try to retrieve table name</span>
  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$idx_is_present</span> -eq <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_indexes_list <span class="s2">&quot;not_primary&quot;</span> <span class="s2">&quot;S.INDEX_NAME, S.TABLE_NAME&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on get data of index </span><span class="nv">$idx</span><span class="s2">.&quot;</span>

    <span class="nv">idx_table</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;( commons_mariadb_compile_idx: (</span><span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span><span class="s2">) I use index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">${</span><span class="nv">idxtname</span><span class="si">}</span><span class="s2">) (force = </span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">))\n&quot;</span>

  <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">f</span><span class="o">=</span><span class="si">${</span><span class="nv">idx_dir</span><span class="si">}</span>/<span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span>-<span class="si">${</span><span class="nv">idx</span><span class="si">}</span>.sql

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    _logfile_write <span class="s2">&quot;(commons_mariadb_compile_idx) File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(mariadb) File </span><span class="nv">$f</span><span class="s2"> not found.\n&quot;</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;( commons_mariadb_compile_idx: Try to compile index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">)...)\n&quot;</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$idx_is_present</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># POST: index is present and force is equal to 1.</span>

    commons_mariadb_drop_index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

    commons_mariadb_compile_file <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">elif</span> <span class="o">[</span> <span class="nv">$idx_is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      <span class="nb">echo</span> -en <span class="s2">&quot;( commons_mariadb_compile_idx: index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> for table </span><span class="si">${</span><span class="nv">idx_table</span><span class="si">}</span><span class="s2"> is already present. Nothing to do.)\n&quot;</span>

    _logfile_write <span class="s2">&quot;(mariadb) Index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> is already present. Nothing to do.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">elif</span> <span class="o">[</span> <span class="nv">$idx_is_present</span> -eq <span class="m">2</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      <span class="nb">echo</span> -en <span class="s2">&quot;( commons_mariadb_compile_idx: index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> exists for different tables.\nSet table param.)\n&quot;</span>

    _logfile_write <span class="s2">&quot;(mariadb) Index </span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2"> exists for different tables. Set table param for compilation.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="c1"># POST: index not present. I compile it.</span>
    commons_mariadb_compile_file <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-procedures">
<span id="commons-mariadb-compile-all-procedures"></span><h3>commons_mariadb_compile_all_procedures<a class="headerlink" href="#commons-mariadb-compile-all-procedures" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/procedures directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock19'))">(Show/Hide)</a><br /><div id="hiddencodeblock19" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_procedures <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/procedures&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all procedures&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-triggers">
<span id="commons-mariadb-compile-all-triggers"></span><h3>commons_mariadb_compile_all_triggers<a class="headerlink" href="#commons-mariadb-compile-all-triggers" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/triggers directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock20'))">(Show/Hide)</a><br /><div id="hiddencodeblock20" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_triggers <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/triggers&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all triggers&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-functions">
<span id="commons-mariadb-compile-all-functions"></span><h3>commons_mariadb_compile_all_functions<a class="headerlink" href="#commons-mariadb-compile-all-functions" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/functions directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock21'))">(Show/Hide)</a><br /><div id="hiddencodeblock21" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_functions <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/functions&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all functions&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-views">
<span id="commons-mariadb-compile-all-views"></span><h3>commons_mariadb_compile_all_views<a class="headerlink" href="#commons-mariadb-compile-all-views" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/views directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock22'))">(Show/Hide)</a><br /><div id="hiddencodeblock22" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_views <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/views&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all views&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-fkeys">
<span id="commons-mariadb-compile-all-fkeys"></span><h3>commons_mariadb_compile_all_fkeys<a class="headerlink" href="#commons-mariadb-compile-all-fkeys" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/foreign_keys directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (force) if equals to 1, force compilation of all foreign keys also
if already present.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock23'))">(Show/Hide)</a><br /><div id="hiddencodeblock23" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_fkeys <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/foreign_keys&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all foreign keys&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;fkey&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-idxs">
<span id="commons-mariadb-compile-all-idxs"></span><h3>commons_mariadb_compile_all_idxs<a class="headerlink" href="#commons-mariadb-compile-all-idxs" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/indexes directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (force) if equals to 1, force compilation of all indexes also
if already present.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock24'))">(Show/Hide)</a><br /><div id="hiddencodeblock24" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_idxs <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/indexes&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all indexes&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;idx&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-events">
<span id="commons-mariadb-compile-all-events"></span><h3>commons_mariadb_compile_all_events<a class="headerlink" href="#commons-mariadb-compile-all-events" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under MARIADB_DIR/events directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock25'))">(Show/Hide)</a><br /><div id="hiddencodeblock25" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_events <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MARIADB_DIR</span><span class="s2">/schedulers&quot;</span>

  commons_mariadb_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all events&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-compile-all-from-dir">
<span id="commons-mariadb-compile-all-from-dir"></span><h3>commons_mariadb_compile_all_from_dir<a class="headerlink" href="#commons-mariadb-compile-all-from-dir" title="Permalink to this headline">¶</a></h3>
<p>Compile all files from input directory with .sql extension.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (directory) Directory where there are files to compile.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg_head) Title message insert on logfile before compile files.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (msg) message insert on logfile before compile files.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (type) Identify type of directory: fkey|procedure|function|view.
Optional.</li>
<li><code class="docutils literal"><span class="pre">$5</span></code>: (closure) custom parameter with a value relative to type.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock26'))">(Show/Hide)</a><br /><div id="hiddencodeblock26" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_compile_all_from_dir <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">msg_head</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">dtype</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">closure</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$5</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fb</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ex_f</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">exc</span><span class="o">=</span>0

  _logfile_write <span class="s2">&quot;(mariadb) Start compilation </span><span class="nv">$msg_head</span><span class="s2">: </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">for</span> i in <span class="nv">$directory</span>/*.sql <span class="p">;</span> <span class="k">do</span>

    <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="p">;</span> <span class="k">then</span>
      <span class="k">continue</span>
    <span class="k">fi</span>

    <span class="nv">fk_is_present</span><span class="o">=</span>1
    <span class="nv">exc</span><span class="o">=</span>0

    <span class="nv">fb</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$i</span><span class="sb">`</span>
    <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fb</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Check if file is excluded</span>
    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;</span><span class="nv">$MARIADB_COMPILE_FILES_EXCLUDED</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="k">for</span> e in <span class="nv">$MARIADB_COMPILE_FILES_EXCLUDED</span> <span class="p">;</span> <span class="k">do</span>

        <span class="nv">ex_f</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$e</span><span class="sb">`</span>
        <span class="nv">ex_f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ex_f</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ex_f</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
          <span class="nv">exc</span><span class="o">=</span>1

          _logfile_write <span class="s2">&quot;(mariadb) Exclude file </span><span class="nv">$fb</span><span class="s2"> for user request.&quot;</span>

          <span class="nb">break</span>
        <span class="k">fi</span>

      <span class="k">done</span> <span class="c1"># end for exclueded</span>

    <span class="k">fi</span>

    <span class="c1"># If file is excluded go to the next</span>
    <span class="o">[</span> <span class="nv">$exc</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
      <span class="s2">&quot;(commons_mariadb_compile_all_from_dir: compile file [</span><span class="nv">$i</span><span class="s2">].\n&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;fkey&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

      commons_mariadb_compile_fkey <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">closure</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">else</span>

      <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;idx&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

        commons_mariadb_compile_idx <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">closure</span><span class="si">}</span><span class="s2">&quot;</span>

      <span class="k">else</span>

        commons_mariadb_compile_file <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span>

      <span class="k">fi</span>

    <span class="k">fi</span>

    <span class="c1"># POST: on error go to next file</span>

  <span class="k">done</span> <span class="c1"># end for</span>

  _logfile_write <span class="s2">&quot;(mariadb) End compilation </span><span class="nv">$msg_head</span><span class="s2">: </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-fkeys">
<span id="commons-mariadb-count-fkeys"></span><h3>commons_mariadb_count_fkeys<a class="headerlink" href="#commons-mariadb-count-fkeys" title="Permalink to this headline">¶</a></h3>
<p>Count number of foreign keys present on database.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (tname) table name to use on count foreign keys. Optional.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (mode) if tname is present this field could be used for identify
if count must be done for foreign key of the table or
foreign keys that reference table.
Optional field.
Possible values are: &#8220;in&#8221; (default) | &#8220;ref&#8221;</li>
</ul>
<p><em>Returns</em>:</p>
<p>Number of foreign keys found.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock27'))">(Show/Hide)</a><br /><div id="hiddencodeblock27" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_fkeys <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">mode</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -z <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND TS.TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND KCU.REFERENCED_TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM (</span>
<span class="s2">      SELECT</span>
<span class="s2">      KCU.CONSTRAINT_NAME,</span>
<span class="s2">      KCU.TABLE_NAME,</span>
<span class="s2">      GROUP_CONCAT(KCU.COLUMN_NAME ORDER BY KCU.ORDINAL_POSITION) AS COLUMN_NAME,</span>
<span class="s2">      KCU.REFERENCED_TABLE_NAME,</span>
<span class="s2">      GROUP_CONCAT(KCU.REFERENCED_COLUMN_NAME ORDER BY KCU.ORDINAL_POSITION) AS REFERENCED_COLUMN_NAME,</span>
<span class="s2">      RC.UPDATE_RULE,</span>
<span class="s2">      RC.DELETE_RULE</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS TS,</span>
<span class="s2">         INFORMATION_SCHEMA.KEY_COLUMN_USAGE KCU,</span>
<span class="s2">         INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS RC</span>
<span class="s2">    WHERE TS.TABLE_SCHEMA = TS.CONSTRAINT_SCHEMA</span>
<span class="s2">    AND TS.CONSTRAINT_SCHEMA = KCU.TABLE_SCHEMA</span>
<span class="s2">    AND KCU.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND RC.CONSTRAINT_SCHEMA = KCU.TABLE_SCHEMA</span>
<span class="s2">    AND TS.CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">    AND TS.CONSTRAINT_NAME = KCU.CONSTRAINT_NAME</span>
<span class="s2">    AND RC.CONSTRAINT_NAME = TS.CONSTRAINT_NAME</span>
<span class="s2">    AND RC.UNIQUE_CONSTRAINT_SCHEMA = KCU.TABLE_SCHEMA</span>
<span class="s2">    AND KCU.REFERENCED_TABLE_NAME IS NOT NULL</span>
<span class="s2">    </span><span class="nv">$andwhere</span><span class="s2"></span>
<span class="s2">    GROUP BY KCU.CONSTRAINT_NAME</span>
<span class="s2">    ORDER BY TS.TABLE_NAME, TS.CONSTRAINT_NAME </span>
<span class="s2">    ) TMP;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count foreign keys.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-procedures">
<span id="commons-mariadb-count-procedures"></span><h3>commons_mariadb_count_procedures<a class="headerlink" href="#commons-mariadb-count-procedures" title="Permalink to this headline">¶</a></h3>
<p>Count number of procedures present on database.</p>
<p><em>Returns</em>:</p>
<p>Number of procedures found.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock28'))">(Show/Hide)</a><br /><div id="hiddencodeblock28" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_procedures <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;PROCEDURE&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count procedures.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-functions">
<span id="commons-mariadb-count-functions"></span><h3>commons_mariadb_count_functions<a class="headerlink" href="#commons-mariadb-count-functions" title="Permalink to this headline">¶</a></h3>
<p>Count number of functions present on schema.</p>
<p><em>Returns</em>:</p>
<p>Number of functions found on schema.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock29'))">(Show/Hide)</a><br /><div id="hiddencodeblock29" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_functions <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;FUNCTION&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count functions.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-triggers">
<span id="commons-mariadb-count-triggers"></span><h3>commons_mariadb_count_triggers<a class="headerlink" href="#commons-mariadb-count-triggers" title="Permalink to this headline">¶</a></h3>
<p>Count number of triggers defined on schema.</p>
<p><em>Returns</em>:</p>
<p>Number of triggers found on schema.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock30'))">(Show/Hide)</a><br /><div id="hiddencodeblock30" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_triggers <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TRIGGERS</span>
<span class="s2">    WHERE TRIGGER_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ACTION_TIMING IN (&#39;BEFORE&#39;, &#39;AFTER&#39;)</span>
<span class="s2">    AND EVENT_MANIPULATION IN (&#39;INSERT&#39;, &#39;UPDATE&#39;, &#39;DELETE&#39;)</span>
<span class="s2">    AND ACTION_STATEMENT IS NOT NULL;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count triggers.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-views">
<span id="commons-mariadb-count-views"></span><h3>commons_mariadb_count_views<a class="headerlink" href="#commons-mariadb-count-views" title="Permalink to this headline">¶</a></h3>
<p>Count number of views present on schema.</p>
<p><em>Returns</em>:</p>
<p>Number of views available on schema.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock31'))">(Show/Hide)</a><br /><div id="hiddencodeblock31" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_views <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.VIEWS</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count views.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-events">
<span id="commons-mariadb-count-events"></span><h3>commons_mariadb_count_events<a class="headerlink" href="#commons-mariadb-count-events" title="Permalink to this headline">¶</a></h3>
<p>Count number of events present on schema.</p>
<p><em>Returns</em>:</p>
<p>Number of events available on schema.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock32'))">(Show/Hide)</a><br /><div id="hiddencodeblock32" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_events <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.EVENTS</span>
<span class="s2">    WHERE EVENT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count events.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-indexes">
<span id="commons-mariadb-count-indexes"></span><h3>commons_mariadb_count_indexes<a class="headerlink" href="#commons-mariadb-count-indexes" title="Permalink to this headline">¶</a></h3>
<p>Count number of indexes present on database.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (tname) Argument $1 if isn&#8217;t an empty string identify table name.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (idx_types) Argument $2 identify indexes types.
Values are: &#8220;all&#8221; (default), &#8220;primary&#8221;, &#8220;not_primary&#8221;</li>
</ul>
<p><em>Returns</em>:</p>
<p>Number of indexes found.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock33'))">(Show/Hide)</a><br /><div id="hiddencodeblock33" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_indexes <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">idx_types</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;primary&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;AND INDEX_NAME = &#39;PRIMARY&#39;&quot;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;not_primary&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;AND INDEX_NAME &lt;&gt; &#39;PRIMARY&#39;&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM (</span>
<span class="s2">      SELECT *</span>
<span class="s2">      FROM (</span>
<span class="s2">        SELECT TABLE_NAME, INDEX_NAME</span>
<span class="s2">        FROM  INFORMATION_SCHEMA.STATISTICS S</span>
<span class="s2">        WHERE S.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">        </span><span class="si">${</span><span class="nv">andWhere_type</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">${</span><span class="nv">andwhere</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        GROUP BY S.TABLE_NAME, S.INDEX_NAME</span>
<span class="s2">        ORDER BY S.TABLE_NAME, S.INDEX_NAME</span>
<span class="s2">      ) IDX</span>
<span class="s2">      WHERE IDX.INDEX_NAME NOT IN (</span>
<span class="s2">            SELECT TC.CONSTRAINT_NAME AS INDEX_NAME</span>
<span class="s2">            FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC</span>
<span class="s2">            WHERE TC.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">            AND TC.CONSTRAINT_SCHEMA = TC.TABLE_SCHEMA</span>
<span class="s2">            AND TC.CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">      )</span>
<span class="s2">    ) TMP</span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count indexes.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-procedure">
<span id="commons-mariadb-check-if-exist-procedure"></span><h3>commons_mariadb_check_if_exist_procedure<a class="headerlink" href="#commons-mariadb-check-if-exist-procedure" title="Permalink to this headline">¶</a></h3>
<p>Check if exists procedure with name in input on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock34'))">(Show/Hide)</a><br /><div id="hiddencodeblock34" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_procedure <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists procedure </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;PROCEDURE&#39;</span>
<span class="s2">    AND ROUTINE_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; ;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-function">
<span id="commons-mariadb-check-if-exist-function"></span><h3>commons_mariadb_check_if_exist_function<a class="headerlink" href="#commons-mariadb-check-if-exist-function" title="Permalink to this headline">¶</a></h3>
<p>Check if exists function with name in input on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock35'))">(Show/Hide)</a><br /><div id="hiddencodeblock35" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_function <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists function </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;FUNCTION&#39;</span>
<span class="s2">    AND ROUTINE_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-view">
<span id="commons-mariadb-check-if-exist-view"></span><h3>commons_mariadb_check_if_exist_view<a class="headerlink" href="#commons-mariadb-check-if-exist-view" title="Permalink to this headline">¶</a></h3>
<p>Check if exists view with name in input on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock36'))">(Show/Hide)</a><br /><div id="hiddencodeblock36" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_view <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists view </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.VIEWS</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND TABLE_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; ;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-fkey">
<span id="commons-mariadb-check-if-exist-fkey"></span><h3>commons_mariadb_check_if_exist_fkey<a class="headerlink" href="#commons-mariadb-check-if-exist-fkey" title="Permalink to this headline">¶</a></h3>
<p>Check if exists foreign keys with name in input on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
<li><code class="docutils literal"><span class="pre">2</span></code>: if argument tname is not present this means that there are
two foreign key with same name.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock37'))">(Show/Hide)</a><br /><div id="hiddencodeblock37" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_fkey <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists foreign key with </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">andWhere</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andWhere</span><span class="o">=</span><span class="s2">&quot;AND TABLE_NAME = &#39;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM</span>
<span class="s2">    (</span>
<span class="s2">      SELECT CONSTRAINT_NAME, TABLE_NAME</span>
<span class="s2">      FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS</span>
<span class="s2">      WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">      AND CONSTRAINT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND CONSTRAINT_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39;</span>
<span class="s2">      </span><span class="si">${</span><span class="nv">andWhere</span><span class="si">}</span><span class="s2"></span>
<span class="s2">      GROUP BY CONSTRAINT_NAME, TABLE_NAME</span>
<span class="s2">     ) TMP &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">elif</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;2&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>2
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-index">
<span id="commons-mariadb-check-if-exist-index"></span><h3>commons_mariadb_check_if_exist_index<a class="headerlink" href="#commons-mariadb-check-if-exist-index" title="Permalink to this headline">¶</a></h3>
<p>Check if exists index with name and table name in input on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (index_name) Identify index name.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (table_name) Identify table name of the index.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock38'))">(Show/Hide)</a><br /><div id="hiddencodeblock38" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_index <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists index key with </span><span class="nv">$name</span><span class="s2"> on table </span><span class="nv">$tname</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM (</span>
<span class="s2">       SELECT TABLE_NAME, INDEX_NAME</span>
<span class="s2">      FROM  INFORMATION_SCHEMA.STATISTICS</span>
<span class="s2">      WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND INDEX_NAME NOT IN (</span>
<span class="s2">          SELECT TC.CONSTRAINT_NAME</span>
<span class="s2">          FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC</span>
<span class="s2">          WHERE TC.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">          AND TC.CONSTRAINT_SCHEMA = TC.TABLE_SCHEMA</span>
<span class="s2">          AND TC.CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">      )</span>
<span class="s2">      AND TABLE_NAME = &#39;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">      AND INDEX_NAME = &#39;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">      GROUP BY TABLE_NAME, INDEX_NAME</span>
<span class="s2">      ORDER BY TABLE_NAME, INDEX_NAME</span>
<span class="s2">    ) T&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-triggers-list">
<span id="commons-mariadb-get-triggers-list"></span><h3>commons_mariadb_get_triggers_list<a class="headerlink" href="#commons-mariadb-get-triggers-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of triggers defined on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock39'))">(Show/Hide)</a><br /><div id="hiddencodeblock39" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_triggers_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT TRIGGER_NAME, EVENT_OBJECT_TABLE, ACTION_TIMING, EVENT_MANIPULATION</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TRIGGERS</span>
<span class="s2">    WHERE TRIGGER_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ACTION_TIMING IN (&#39;BEFORE&#39;, &#39;AFTER&#39;)</span>
<span class="s2">    AND EVENT_MANIPULATION IN (&#39;INSERT&#39;, &#39;UPDATE&#39;, &#39;DELETE&#39;)</span>
<span class="s2">    AND ACTION_STATEMENT IS NOT NULL</span>
<span class="s2">    ORDER BY EVENT_OBJECT_TABLE, ACTION_ORDER;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-count-tables">
<span id="commons-mariadb-count-tables"></span><h3>commons_mariadb_count_tables<a class="headerlink" href="#commons-mariadb-count-tables" title="Permalink to this headline">¶</a></h3>
<p>Count tables of the schema.</p>
<p><em>Returns</em>:</p>
<p>Number of tables found.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock40'))">(Show/Hide)</a><br /><div id="hiddencodeblock40" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_count_tables <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TABLES</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on count tables.&quot;</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$MYSQL_OUTPUT</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-fkeys-list">
<span id="commons-mariadb-get-fkeys-list"></span><h3>commons_mariadb_get_fkeys_list<a class="headerlink" href="#commons-mariadb-get-fkeys-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of foreign keys defined on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (all) If valorized then list contains columns CONSTRAINT_NAME,
TABLE_NAME, COLUMN_NAME, REFERENCED_TABLE_NAME,
REFERENCED_COLUMN_NAME, UPDATE_RULE, DELETE_RULE</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (custom_column) If all paramaeter is empty through this parameter
is possible define columns to return.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (fkey_name) Foreign key name to filter. Optional.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (tname) Table name to use on filter. Optional</li>
<li><code class="docutils literal"><span class="pre">$5</span></code>: (mode) if tname is present this field could be used for identify
count must be done for count foreign key of the table or foreign
keys that reference table. Optional parameter.
Possible values are: &#8220;in&#8221; (default) | &#8220;ref&#8221;</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock41'))">(Show/Hide)</a><br /><div id="hiddencodeblock41" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_fkeys_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">all</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">custom_column</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">fkey_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">mode</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$5</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ext_custom_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ext_all_columns</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="c1"># NOTE: Currently if all is not an empty string</span>
  <span class="c1">#       I think that custom_column is not used.</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$all</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      KCU.CONSTRAINT_NAME,</span>
<span class="s2">      KCU.TABLE_NAME,</span>
<span class="s2">      GROUP_CONCAT(KCU.COLUMN_NAME ORDER BY KCU.ORDINAL_POSITION) AS COLUMN_NAME,</span>
<span class="s2">      KCU.REFERENCED_TABLE_NAME,</span>
<span class="s2">      GROUP_CONCAT(KCU.REFERENCED_COLUMN_NAME ORDER BY KCU.ORDINAL_POSITION) AS REFERENCED_COLUMN_NAME,</span>
<span class="s2">      RC.UPDATE_RULE,</span>
<span class="s2">      RC.DELETE_RULE</span>
<span class="s2">    &quot;</span>
    <span class="c1"># KCU.POSITION_IN_UNIQUE_CONSTRAINT</span>

    <span class="c1"># RC.MATCH_OPTION,</span>
    <span class="c1"># For now only possible value for this field is None.</span>
    <span class="c1"># See: http://dev.mysql.com/doc/refman/5.7/en/referential-constraints-table.html</span>

    <span class="nv">ext_all_columns</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      TMP.CONSTRAINT_NAME,</span>
<span class="s2">      TMP.TABLE_NAME,</span>
<span class="s2">      TMP.COLUMN_NAME,</span>
<span class="s2">      TMP.REFERENCED_TABLE_NAME,</span>
<span class="s2">      TMP.REFERENCED_COLUMN_NAME,</span>
<span class="s2">      TMP.UPDATE_RULE,</span>
<span class="s2">      TMP.DELETE_RULE</span>
<span class="s2">    &quot;</span>

  <span class="k">else</span>

    <span class="c1"># TODO: Currently replace only KCU table.</span>
    <span class="nv">ext_custom_column</span><span class="o">=</span><span class="si">${</span><span class="nv">custom_column</span><span class="p">//KCU./TMP.</span><span class="si">}</span>

  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fkey_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">fk_name</span><span class="o">=</span><span class="s2">&quot;AND TS.CONSTRAINT_NAME = &#39;</span><span class="si">${</span><span class="nv">fkey_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -z <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND TS.TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND KCU.REFERENCED_TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT_WS(&#39;|&#39;, </span><span class="si">${</span><span class="nv">ext_all_columns</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ext_custom_column</span><span class="si">}</span><span class="s2">) AS ANS</span>
<span class="s2">    FROM (</span>
<span class="s2">      SELECT </span><span class="si">${</span><span class="nv">all_column</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">custom_column</span><span class="si">}</span><span class="s2"></span>
<span class="s2">      FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS TS,</span>
<span class="s2">           INFORMATION_SCHEMA.KEY_COLUMN_USAGE KCU,</span>
<span class="s2">           INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS RC</span>
<span class="s2">      WHERE TS.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND TS.CONSTRAINT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND KCU.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND RC.CONSTRAINT_SCHEMA = KCU.TABLE_SCHEMA</span>
<span class="s2">      AND TS.CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">      AND TS.CONSTRAINT_NAME = KCU.CONSTRAINT_NAME</span>
<span class="s2">      AND RC.CONSTRAINT_NAME = TS.CONSTRAINT_NAME</span>
<span class="s2">      AND RC.UNIQUE_CONSTRAINT_SCHEMA = KCU.TABLE_SCHEMA</span>
<span class="s2">      AND KCU.REFERENCED_TABLE_NAME IS NOT NULL</span>
<span class="s2">      </span><span class="si">${</span><span class="nv">fk_name</span><span class="si">}</span><span class="s2"></span>
<span class="s2">      </span><span class="si">${</span><span class="nv">andwhere</span><span class="si">}</span><span class="s2"></span>
<span class="s2">      GROUP BY KCU.CONSTRAINT_NAME</span>
<span class="s2">      ORDER BY TS.TABLE_NAME, TS.CONSTRAINT_NAME</span>
<span class="s2">    ) TMP</span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-indexes-list">
<span id="commons-mariadb-get-indexes-list"></span><h3>commons_mariadb_get_indexes_list<a class="headerlink" href="#commons-mariadb-get-indexes-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of indexes defined on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (idx_types) Identify indexes types.
Values are: &#8220;all&#8221; (default), &#8220;primary&#8221;, &#8220;not_primary&#8221;</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (custom_column) If not empty defined list of column returned.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (tname) Table name to use on filter. Optional</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (index_name) Index name to filter. Optional.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock42'))">(Show/Hide)</a><br /><div id="hiddencodeblock42" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_indexes_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">idx_types</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">custom_column</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">iname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">andWhere_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ext_custom_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ext_all_columns</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$custom_column</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      S.TABLE_NAME,</span>
<span class="s2">      S.NON_UNIQUE,</span>
<span class="s2">      S.INDEX_NAME,</span>
<span class="s2">      GROUP_CONCAT(S.COLUMN_NAME ORDER BY S.SEQ_IN_INDEX) AS KEY_COLUMNS,</span>
<span class="s2">      S.INDEX_TYPE,</span>
<span class="s2">      S.COMMENT,</span>
<span class="s2">      S.INDEX_COMMENT</span>
<span class="s2">    &quot;</span>
    <span class="c1"># On Mysql 5.1 INDEX_COMMENT is not available.</span>

    <span class="nv">ext_all_columns</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      TMP.TABLE_NAME,</span>
<span class="s2">      TMP.NON_UNIQUE,</span>
<span class="s2">      TMP.INDEX_NAME,</span>
<span class="s2">      TMP.KEY_COLUMNS,</span>
<span class="s2">      TMP.INDEX_TYPE,</span>
<span class="s2">      TMP.COMMENT,</span>
<span class="s2">      TMP.INDEX_COMMENT</span>
<span class="s2">    &quot;</span>
  <span class="k">else</span>

    <span class="c1"># TODO: Currently replace only KCU table.</span>
    <span class="nv">ext_custom_column</span><span class="o">=</span><span class="si">${</span><span class="nv">custom_column</span><span class="p">//S./TMP.</span><span class="si">}</span>

  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;primary&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;AND S.INDEX_NAME = &#39;PRIMARY&#39;&quot;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$idx_types</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;not_primary&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">andWhere_type</span><span class="o">=</span><span class="s2">&quot;AND S.INDEX_NAME &lt;&gt; &#39;PRIMARY&#39;&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andWhere_name</span><span class="o">=</span><span class="s2">&quot;AND S.TABLE_NAME = &#39;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">iname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andWhere_iname</span><span class="o">=</span><span class="s2">&quot;AND S.INDEX_NAME = &#39;</span><span class="si">${</span><span class="nv">iname</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT_WS(&#39;|&#39;, </span><span class="si">${</span><span class="nv">ext_all_columns</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ext_custom_column</span><span class="si">}</span><span class="s2">) AS ANS</span>
<span class="s2">    FROM (</span>
<span class="s2">      SELECT *</span>
<span class="s2">      FROM (</span>
<span class="s2">        SELECT </span><span class="si">${</span><span class="nv">all_column</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">custom_column</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        FROM  INFORMATION_SCHEMA.STATISTICS S</span>
<span class="s2">        WHERE S.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">        </span><span class="si">${</span><span class="nv">andWhere_name</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">${</span><span class="nv">andWhere_iname</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">${</span><span class="nv">andWhere_type</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        GROUP BY S.TABLE_NAME, S.INDEX_NAME</span>
<span class="s2">        ORDER BY S.TABLE_NAME, S.INDEX_NAME</span>
<span class="s2">      ) IDX</span>
<span class="s2">      WHERE IDX.INDEX_NAME NOT IN (</span>
<span class="s2">            SELECT TC.CONSTRAINT_NAME AS INDEX_NAME</span>
<span class="s2">            FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC</span>
<span class="s2">            WHERE TC.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">            AND TC.CONSTRAINT_SCHEMA = TC.TABLE_SCHEMA</span>
<span class="s2">            AND TC.CONSTRAINT_TYPE = &#39;FOREIGN KEY&#39;</span>
<span class="s2">      )</span>
<span class="s2">    ) TMP</span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-tables-list">
<span id="commons-mariadb-get-tables-list"></span><h3>commons_mariadb_get_tables_list<a class="headerlink" href="#commons-mariadb-get-tables-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of tables defined on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (all) If valorized then list contains columns TABLE_NAME,
ENGINE, TABLE_ROWS, DATA_LENGTH, CHARACTER_SET_NAME, CREATE_TIME,
UPDATE_TIME</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (custom_column) If all paramaeter is empty through this parameter
is possible define columns to return.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (tname) Table name to use on filter. Optional</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock43'))">(Show/Hide)</a><br /><div id="hiddencodeblock43" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_tables_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">all</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">custom_column</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$all</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;,T.ENGINE,T.TABLE_ROWS,T.DATA_LENGTH,CCSA.CHARACTER_SET_NAME,T.CREATE_TIME,T.UPDATE_TIME&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;AND T.TABLE_NAME = &#39;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT T.TABLE_NAME </span><span class="si">${</span><span class="nv">all_column</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">custom_column</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    FROM INFORMATION_SCHEMA.TABLES T,</span>
<span class="s2">         INFORMATION_SCHEMA.COLLATION_CHARACTER_SET_APPLICABILITY CCSA</span>
<span class="s2">    WHERE T.TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">      AND T.TABLE_COLLATION = CCSA.COLLATION_NAME</span>
<span class="s2">      </span><span class="si">${</span><span class="nv">andwhere</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    ORDER BY TABLE_NAME;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-desc-table">
<span id="commons-mariadb-desc-table"></span><h3>commons_mariadb_desc_table<a class="headerlink" href="#commons-mariadb-desc-table" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of columns of input table.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (tname) Table name to use on filter.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (custom_column) If all paramaeter is empty through this parameter
is possible define columns to return.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (cname) Permit to filter for column name if not empty.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock44'))">(Show/Hide)</a><br /><div id="hiddencodeblock44" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_desc_table <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">custom_column</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">andwhere</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$cname</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">andWhere</span><span class="o">=</span><span class="s2">&quot;AND COLUMN_NAME = &#39;</span><span class="nv">$cname</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$custom_column</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;CONCAT_WS(&#39;|&#39;,</span>
<span class="s2">       COLUMN_NAME,</span>
<span class="s2">       IS_NULLABLE,</span>
<span class="s2">       UPPER(COLUMN_TYPE),</span>
<span class="s2">       COLUMN_KEY,</span>
<span class="s2">       UPPER(EXTRA)) AS C,</span>
<span class="s2">       &#39;|&#39; AS S,</span>
<span class="s2">       COLUMN_DEFAULT</span>
<span class="s2">    &quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT </span><span class="si">${</span><span class="nv">all_column</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">custom_column</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    FROM INFORMATION_SCHEMA.COLUMNS</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;</span>
<span class="s2">    </span><span class="si">${</span><span class="nv">andWhere</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    ORDER BY ORDINAL_POSITION;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-exist-table">
<span id="commons-mariadb-exist-table"></span><h3>commons_mariadb_exist_table<a class="headerlink" href="#commons-mariadb-exist-table" title="Permalink to this headline">¶</a></h3>
<p>Check if exists table in input.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (tname) Table name to search.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if table exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error or if table is not exists.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock45'))">(Show/Hide)</a><br /><div id="hiddencodeblock45" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_exist_table <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1)</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TABLES</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND TABLE_NAME = &#39;</span><span class="nv">$tname</span><span class="s2">&#39;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-exist-event">
<span id="commons-mariadb-exist-event"></span><h3>commons_mariadb_exist_event<a class="headerlink" href="#commons-mariadb-exist-event" title="Permalink to this headline">¶</a></h3>
<p>Check if exists event in input.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (ename) Event name to search.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if table exists.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error or if table is not exists.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock46'))">(Show/Hide)</a><br /><div id="hiddencodeblock46" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_exist_event <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">ename</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1)</span>
<span class="s2">    FROM INFORMATION_SCHEMA.EVENTS</span>
<span class="s2">    WHERE EVENT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND EVENT_NAME = &#39;</span><span class="nv">$ename</span><span class="s2">&#39;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-procedures-list">
<span id="commons-mariadb-get-procedures-list"></span><h3>commons_mariadb_get_procedures_list<a class="headerlink" href="#commons-mariadb-get-procedures-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of procedures defined on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (all) If valorized then are returned columsn ROUTINE_NAME,
DEFINER, CREATED, LAST_ALTERED otherwize only
ROUTINE_NAME.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock47'))">(Show/Hide)</a><br /><div id="hiddencodeblock47" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_procedures_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">all</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$all</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;,DEFINER, CREATED, LAST_ALTERED&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT ROUTINE_NAME </span><span class="nv">$all_column</span><span class="s2"></span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;PROCEDURE&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-functions-list">
<span id="commons-mariadb-get-functions-list"></span><h3>commons_mariadb_get_functions_list<a class="headerlink" href="#commons-mariadb-get-functions-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of functions defined on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (all) If valorized then are returned columsn ROUTINE_NAME,
DEFINER, CREATED, LAST_ALTERED otherwize only
ROUTINE_NAME.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock48'))">(Show/Hide)</a><br /><div id="hiddencodeblock48" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_functions_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">all</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$all</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">all_column</span><span class="o">=</span><span class="s2">&quot;,DEFINER, CREATED, LAST_ALTERED&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT ROUTINE_NAME </span><span class="nv">$all_column</span><span class="s2"></span>
<span class="s2">    FROM INFORMATION_SCHEMA.ROUTINES</span>
<span class="s2">    WHERE ROUTINE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND ROUTINE_TYPE = &#39;FUNCTION&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-events-list">
<span id="commons-mariadb-get-events-list"></span><h3>commons_mariadb_get_events_list<a class="headerlink" href="#commons-mariadb-get-events-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of events defined on schema.
Data are returned as a row with pipe (|) separator.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (opt) If equal to &#8216;all&#8217; then are returned columns EVENT_NAME,
DEFINER, TIME_ZONE, EVENT_TYPE, EXECUTE_AT, INTERVAL_VALUE,
INTERVAL_FIELD, STARTS , ENDS, STATUS, ON_COMPLETION,
CREATED, LAST_ALTERED, LAST_EXECUTED, EVENT_COMMENT
otherwise EVENT_NAME, DEFINED, TIME_ZONE, EVENT_TYPE,
STATUS, CREATED end LAST_EXECUTED.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (ename) Name of the event.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock49'))">(Show/Hide)</a><br /><div id="hiddencodeblock49" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_events_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">opt</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">ename</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">add_columns</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">and_where</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$opt</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">opt</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">add_columns</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">        ,</span>
<span class="s2">        DEFINER,</span>
<span class="s2">        TIME_ZONE,</span>
<span class="s2">        EVENT_TYPE,</span>
<span class="s2">        COALESCE(EXECUTE_AT, &#39;&#39;),</span>
<span class="s2">        COALESCE(INTERVAL_VALUE, &#39;&#39;),</span>
<span class="s2">        COALESCE(INTERVAL_FIELD, &#39;&#39;),</span>
<span class="s2">        COALESCE(STARTS, &#39;&#39;),</span>
<span class="s2">        COALESCE(ENDS, &#39;&#39;),</span>
<span class="s2">        STATUS,</span>
<span class="s2">        ON_COMPLETION,</span>
<span class="s2">        CREATED,</span>
<span class="s2">        LAST_ALTERED,</span>
<span class="s2">        COALESCE(LAST_EXECUTED, &#39;&#39;),</span>
<span class="s2">        COALESCE(EVENT_COMMENT)</span>
<span class="s2">      &quot;</span>
    <span class="k">else</span>
      <span class="nv">add_columns</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">        ,</span>
<span class="s2">        DEFINER,</span>
<span class="s2">        TIME_ZONE,</span>
<span class="s2">        EVENT_TYPE,</span>
<span class="s2">        STATUS,</span>
<span class="s2">        CREATED,</span>
<span class="s2">        COALESCE(LAST_EXECUTED, &#39;&#39;)</span>
<span class="s2">      &quot;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ename</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">and_where</span><span class="o">=</span><span class="s2">&quot;AND EVENT_NAME = &#39;</span><span class="si">${</span><span class="nv">ename</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT_WS(&#39;|&#39;, EVENT_NAME </span><span class="si">${</span><span class="nv">add_columns</span><span class="si">}</span><span class="s2">) AS ANS</span>
<span class="s2">    FROM INFORMATION_SCHEMA.EVENTS</span>
<span class="s2">    WHERE EVENT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    </span><span class="si">${</span><span class="nv">and_where</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-views-list">
<span id="commons-mariadb-get-views-list"></span><h3>commons_mariadb_get_views_list<a class="headerlink" href="#commons-mariadb-get-views-list" title="Permalink to this headline">¶</a></h3>
<p>Save on <code class="docutils literal"><span class="pre">_mariadb_ans</span></code> variable list of views defined on schema.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error.</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock50'))">(Show/Hide)</a><br /><div id="hiddencodeblock50" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_views_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT TABLE_NAME, IS_UPDATABLE</span>
<span class="s2">    FROM INFORMATION_SCHEMA.VIEWS</span>
<span class="s2">    WHERE TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-check-if-exist-trigger">
<span id="commons-mariadb-check-if-exist-trigger"></span><h3>commons_mariadb_check_if_exist_trigger<a class="headerlink" href="#commons-mariadb-check-if-exist-trigger" title="Permalink to this headline">¶</a></h3>
<p>Check if exists a trigger with name in input on schema.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the trigger to search</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) Name of the table of the trigger to search.
Optional paramenter.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: if exists</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: if not exists</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock51'))">(Show/Hide)</a><br /><div id="hiddencodeblock51" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_check_if_exist_trigger <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">errmsg</span><span class="o">=</span><span class="s2">&quot;Error on check if exists trigger </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="nb">local</span> <span class="nv">whereCond</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">whereCond</span><span class="o">=</span><span class="s2">&quot;AND EVENT_OBJECT_TABLE = &#39;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT COUNT(1) AS CNT</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TRIGGERS</span>
<span class="s2">    WHERE TRIGGER_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND TRIGGER_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; </span>
<span class="s2">    AND ACTION_TIMING IN (&#39;BEFORE&#39;, &#39;AFTER&#39;)</span>
<span class="s2">    AND EVENT_MANIPULATION IN (&#39;INSERT&#39;, &#39;UPDATE&#39;, &#39;DELETE&#39;)</span>
<span class="s2">    AND ACTION_STATEMENT IS NOT NULL</span>
<span class="s2">    </span><span class="si">${</span><span class="nv">whereCond</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;</span><span class="nv">$errmsg</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">result</span><span class="o">=</span>0
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-procedure">
<span id="commons-mariadb-download-procedure"></span><h3>commons_mariadb_download_procedure<a class="headerlink" href="#commons-mariadb-download-procedure" title="Permalink to this headline">¶</a></h3>
<p>Download a procedure to MARIADB_DIR/procedures directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the procedure.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock52'))">(Show/Hide)</a><br /><div id="hiddencodeblock52" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_procedure <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">proceduresdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/procedures&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$proceduresdir</span><span class="s2">/</span><span class="nv">$name</span><span class="s2">.sql&quot;</span>

  commons_mariadb_check_if_exist_procedure <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;Procedure </span><span class="nv">$name</span><span class="s2"> not found.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$proceduresdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$proceduresdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="nb">local</span> <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT(&#39;CREATE PROCEDURE \`</span><span class="nv">$name</span><span class="s2">\` (&#39;, param_list, &#39;)&#39;,</span>
<span class="s2">                  CASE R.IS_DETERMINISTIC WHEN &#39;NO&#39; THEN &#39;&#39; ELSE &#39;\nDETERMINISTIC&#39; END</span>
<span class="s2">           ) AS SCRIPT</span>
<span class="s2">    FROM mysql.proc M,</span>
<span class="s2">         INFORMATION_SCHEMA.ROUTINES R</span>
<span class="s2">    WHERE name = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND db = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND R.ROUTINE_NAME = name</span>
<span class="s2">    AND R.ROUTINE_SCHEMA = db;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on download procedure params of the procedure </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT body</span>
<span class="s2">    FROM mysql.proc</span>
<span class="s2">    WHERE name = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND db = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;PROCEDURE_BODY&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="c1">#escape_var &quot;PROCEDURE_BODY&quot;</span>

  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">DROP PROCEDURE IF EXISTS \`</span><span class="nv">$name</span><span class="s2">\`;</span>

<span class="s2">DELIMITER \$\$</span>
<span class="s2">USE \`DB_NAME\`\$\$</span>
<span class="nv">$MYSQL_OUTPUT</span><span class="s2"></span>
<span class="nv">$PROCEDURE_BODY</span><span class="s2"></span>
<span class="s2">&quot;</span>

  <span class="nb">unset</span> PROCEDURE_BODY

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-function">
<span id="commons-mariadb-download-function"></span><h3>commons_mariadb_download_function<a class="headerlink" href="#commons-mariadb-download-function" title="Permalink to this headline">¶</a></h3>
<p>Download a function to MARIADB_DIR/functions directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the function.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock53'))">(Show/Hide)</a><br /><div id="hiddencodeblock53" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_function <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>

  <span class="nb">local</span> <span class="nv">functionsdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/functions&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$functionsdir</span><span class="s2">/</span><span class="nv">$name</span><span class="s2">.sql&quot;</span>

  commons_mariadb_check_if_exist_function <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;Function </span><span class="nv">$name</span><span class="s2"> not found.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$functionsdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$functionsdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="nb">local</span> <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT(&#39;CREATE FUNCTION \`</span><span class="nv">$name</span><span class="s2">\` (&#39;, param_list, &#39;) RETURNS &#39;, returns,</span>
<span class="s2">                  CASE R.IS_DETERMINISTIC WHEN &#39;NO&#39; THEN &#39;&#39; ELSE &#39;\nDETERMINISTIC&#39; END</span>
<span class="s2">           ) AS SCRIPT</span>
<span class="s2">    FROM mysql.proc M,</span>
<span class="s2">         INFORMATION_SCHEMA.ROUTINES R</span>
<span class="s2">    WHERE name = &#39;</span><span class="nv">$name</span><span class="s2">&#39;</span>
<span class="s2">    AND db = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;</span>
<span class="s2">    AND R.ROUTINE_NAME = name</span>
<span class="s2">    AND R.ROUTINE_SCHEMA = db;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on download function params of the function </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT body</span>
<span class="s2">    FROM mysql.proc</span>
<span class="s2">    WHERE name = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND db = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;FUNCTION_BODY&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="c1">#escape_var &quot;FUNCTION_BODY&quot;</span>

  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">DROP FUNCTION IF EXISTS \`</span><span class="nv">$name</span><span class="s2">\`;</span>

<span class="s2">DELIMITER \$\$</span>
<span class="s2">USE \`DB_NAME\`\$\$</span>
<span class="nv">$MYSQL_OUTPUT</span><span class="s2"></span>
<span class="nv">$FUNCTION_BODY</span><span class="s2"></span>
<span class="s2">&quot;</span>

  <span class="nb">unset</span> FUNCTION_BODY

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-trigger">
<span id="commons-mariadb-download-trigger"></span><h3>commons_mariadb_download_trigger<a class="headerlink" href="#commons-mariadb-download-trigger" title="Permalink to this headline">¶</a></h3>
<p>Download a trigger to MARIADB_DIR/triggers directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the trigger to download.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock54'))">(Show/Hide)</a><br /><div id="hiddencodeblock54" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_trigger <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>

  <span class="nb">local</span> <span class="nv">triggersdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/triggers&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$triggersdir</span><span class="s2">/</span><span class="nv">$name</span><span class="s2">.sql&quot;</span>

  commons_mariadb_check_if_exist_trigger <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;Trigger </span><span class="nv">$name</span><span class="s2"> not found or not supported.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$triggersdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$triggersdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="nb">local</span> <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT(&#39;CREATE TRIGGER \`</span><span class="nv">$name</span><span class="s2">\`&#39;,</span>
<span class="s2">           ACTION_TIMING, &#39; &#39;, EVENT_MANIPULATION, &#39; ON \`&#39;, EVENT_OBJECT_TABLE,</span>
<span class="s2">           &#39;\`\nFOR EACH ROW\n&#39;,</span>
<span class="s2">           ACTION_STATEMENT, &#39;;&#39;)</span>
<span class="s2">    FROM INFORMATION_SCHEMA.TRIGGERS</span>
<span class="s2">    WHERE TRIGGER_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND TRIGGER_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on download trigger params of the trigger </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">DROP TRIGGER IF EXISTS \`</span><span class="nv">$name</span><span class="s2">\`;</span>

<span class="s2">DELIMITER \$\$</span>
<span class="s2">USE \`DB_NAME\`\$\$</span>
<span class="nv">$MYSQL_OUTPUT</span><span class="s2"></span>
<span class="s2">&quot;</span>

  <span class="nb">unset</span> MYSQL_BODY

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-event">
<span id="commons-mariadb-download-event"></span><h3>commons_mariadb_download_event<a class="headerlink" href="#commons-mariadb-download-event" title="Permalink to this headline">¶</a></h3>
<p>Download an event to MARIADB_DIR/events directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the event to download.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock55'))">(Show/Hide)</a><br /><div id="hiddencodeblock55" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_event <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">with_tz</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>

  <span class="nb">local</span> <span class="nv">eventsdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/schedulers&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$eventsdir</span><span class="s2">/</span><span class="nv">$name</span><span class="s2">.sql&quot;</span>

  commons_mariadb_exist_event <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;Event </span><span class="nv">$name</span><span class="s2"> not found.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$eventsdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$eventsdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="c1"># Retrieve event data</span>
  commons_mariadb_get_events_list <span class="s2">&quot;all&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Error on get data of event </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.&quot;</span>

  <span class="nb">local</span> <span class="nv">row</span><span class="o">=</span><span class="nv">$_mariadb_ans</span>
  <span class="nb">local</span> <span class="nv">def</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">tzone</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[3]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">etype</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[4]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">exec_at</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[5]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">int_field</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[7]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">int_value</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[6]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">starts</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[8]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">ends</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[9]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">status</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[10]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">on_completion</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[11]}&#39;</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">comment</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($row,a,&quot;|&quot;); print a[15]}&#39;</span><span class="sb">`</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_download_event: def = &#39;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">&#39;, tzone = &#39;</span><span class="si">${</span><span class="nv">tzone</span><span class="si">}</span><span class="s2">&#39;, &quot;</span> <span class="se">\</span>
      <span class="s2">&quot;etype = &#39;</span><span class="si">${</span><span class="nv">etype</span><span class="si">}</span><span class="s2">&#39;, exec_at = &#39;</span><span class="si">${</span><span class="nv">exec_at</span><span class="si">}</span><span class="s2">&#39;, int_field = &#39;</span><span class="si">${</span><span class="nv">int_field</span><span class="si">}</span><span class="s2">&#39;, &quot;</span> <span class="se">\</span>
      <span class="s2">&quot;int_value = &#39;</span><span class="si">${</span><span class="nv">int_value</span><span class="si">}</span><span class="s2">&#39;, starts = &#39;</span><span class="si">${</span><span class="nv">starts</span><span class="si">}</span><span class="s2">&#39;, ends = &#39;</span><span class="si">${</span><span class="nv">ends</span><span class="si">}</span><span class="s2">&#39;, &quot;</span> <span class="se">\</span>
      <span class="s2">&quot;status = &#39;</span><span class="si">${</span><span class="nv">status</span><span class="si">}</span><span class="s2">&#39;, on_completion = &#39;</span><span class="si">${</span><span class="nv">on_completion</span><span class="si">}</span><span class="s2">&#39;, comment = &#39;</span><span class="si">${</span><span class="nv">comment</span><span class="si">}</span><span class="s2">&#39;.\n&quot;</span>


  <span class="nb">local</span> <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT EVENT_DEFINITION</span>
<span class="s2">    FROM INFORMATION_SCHEMA.EVENTS</span>
<span class="s2">    WHERE EVENT_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND EVENT_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on download data of the event </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">at_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">starts_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ends_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">every_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">comm_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">status_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">on_compl_row</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">exec_at</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">at_row</span><span class="o">=</span><span class="s2">&quot;AT &#39;</span><span class="si">${</span><span class="nv">exec_at</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">int_field</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">int_value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">at_row</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">every_row</span><span class="o">=</span><span class="s2">&quot;\n  EVERY </span><span class="si">${</span><span class="nv">int_value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">int_field</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="nv">every_row</span><span class="o">=</span><span class="s2">&quot;EVERY </span><span class="si">${</span><span class="nv">int_value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">int_field</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">on_completion</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="si">${</span><span class="nv">on_completion</span><span class="si">}</span> !<span class="o">=</span> <span class="s2">&quot;NOT PRESERVE&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">on_compl_row</span><span class="o">=</span><span class="s2">&quot;\n  ON COMPLETION PRESERVE&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">starts</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">starts_row</span><span class="o">=</span><span class="s2">&quot;\n  STARTS &#39;</span><span class="si">${</span><span class="nv">starts</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ends</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">ends_row</span><span class="o">=</span><span class="s2">&quot;\n  ENDS &#39;</span><span class="si">${</span><span class="nv">ends</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">status</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">status</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;ENABLED&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">status_row</span><span class="o">=</span><span class="s2">&quot;ENABLE&quot;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">status</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;SLAVESIDE_DISABLED&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">status_row</span><span class="o">=</span><span class="s2">&quot;DISABLE SLAVE&quot;</span>
      <span class="k">else</span> <span class="c1"># DISABLED</span>
        <span class="nv">status_row</span><span class="o">=</span><span class="s2">&quot;DISABLE&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">comment</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">comm_row</span><span class="o">=</span><span class="s2">&quot;\n  COMMENT &#39;</span><span class="si">${</span><span class="nv">comment</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">set_tz</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">with_tz</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">with_tz</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">set_tz</span><span class="o">=</span><span class="s2">&quot;SET time_zone = &#39;</span><span class="si">${</span><span class="nv">tzone</span><span class="si">}</span><span class="s2">&#39; \$\$&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># TODO: check if add IF NOT EXISTS.</span>

  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>

<span class="s2">DELIMITER \$\$</span>
<span class="s2">USE \`DB_NAME\`\$\$</span>

<span class="si">${</span><span class="nv">set_tz</span><span class="si">}</span><span class="s2"></span>
<span class="s2">CREATE EVENT</span>
<span class="s2">  \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ON SCHEDULE</span>
<span class="s2">  </span><span class="si">${</span><span class="nv">at_row</span><span class="si">}${</span><span class="nv">every_row</span><span class="si">}${</span><span class="nv">starts_row</span><span class="si">}${</span><span class="nv">ends_row</span><span class="si">}${</span><span class="nv">on_compl_row</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  </span><span class="si">${</span><span class="nv">status_row</span><span class="si">}${</span><span class="nv">comm_row</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  DO</span>
<span class="s2">    </span><span class="nv">$MYSQL_OUTPUT</span><span class="s2"></span>
<span class="s2">  \$\$</span>

<span class="s2">DELIMITER ;</span>
<span class="s2">&quot;</span>

  <span class="nb">unset</span> MYSQL_BODY

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-view">
<span id="commons-mariadb-download-view"></span><h3>commons_mariadb_download_view<a class="headerlink" href="#commons-mariadb-download-view" title="Permalink to this headline">¶</a></h3>
<p>Download a view to MARIADB_DIR/views directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) Name of the view to download.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock56'))">(Show/Hide)</a><br /><div id="hiddencodeblock56" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_view <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>

  <span class="nb">local</span> <span class="nv">viewsdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/views&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$viewsdir</span><span class="s2">/</span><span class="nv">$name</span><span class="s2">.sql&quot;</span>

  commons_mariadb_check_if_exist_view <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;View </span><span class="nv">$name</span><span class="s2"> not found or not supported.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$viewsdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$viewsdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="nb">local</span> <span class="nv">query</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT(&#39;CREATE OR REPLACE VIEW \`</span><span class="nv">$name</span><span class="s2">\`\nAS &#39;,</span>
<span class="s2">           VIEW_DEFINITION,</span>
<span class="s2">           &#39;;\n&#39;)</span>
<span class="s2">    FROM INFORMATION_SCHEMA.VIEWS</span>
<span class="s2">    WHERE TABLE_NAME = &#39;</span><span class="nv">$name</span><span class="s2">&#39; AND TABLE_SCHEMA = &#39;</span><span class="nv">$MARIADB_DB</span><span class="s2">&#39;;&quot;</span>

  mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$result</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;Error on download views data of the view </span><span class="nv">$name</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="nv">$MYSQL_OUTPUT</span><span class="s2"></span>
<span class="s2">&quot;</span>

  <span class="nb">unset</span> MYSQL_BODY

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-views">
<span id="commons-mariadb-download-all-views"></span><h3>commons_mariadb_download_all_views<a class="headerlink" href="#commons-mariadb-download-all-views" title="Permalink to this headline">¶</a></h3>
<p>Download all views to MARIADB_DIR/views directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock57'))">(Show/Hide)</a><br /><div id="hiddencodeblock57" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_views <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1

  commons_mariadb_count_views
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_views_list <span class="o">||</span> error_handled <span class="s2">&quot;Error on get views name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nv">name</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[1]}&#39;</span><span class="sb">`</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_view <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download view </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download view </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS


  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-procedures">
<span id="commons-mariadb-download-all-procedures"></span><h3>commons_mariadb_download_all_procedures<a class="headerlink" href="#commons-mariadb-download-all-procedures" title="Permalink to this headline">¶</a></h3>
<p>Download all procedures to MARIADB_DIR/procedures directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock58'))">(Show/Hide)</a><br /><div id="hiddencodeblock58" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_procedures <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1

  commons_mariadb_count_procedures
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_procedures_list <span class="o">||</span> error_handled <span class="s2">&quot;Error on get procedures name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_procedure <span class="s2">&quot;</span><span class="nv">$row</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download procedure </span><span class="nv">$row</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download procedure </span><span class="nv">$row</span><span class="s2"> correctly (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-functions">
<span id="commons-mariadb-download-all-functions"></span><h3>commons_mariadb_download_all_functions<a class="headerlink" href="#commons-mariadb-download-all-functions" title="Permalink to this headline">¶</a></h3>
<p>Download all functions to MARIADB_DIR/functions directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock59'))">(Show/Hide)</a><br /><div id="hiddencodeblock59" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_functions <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1

  commons_mariadb_count_functions
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_functions_list <span class="o">||</span> error_handled <span class="s2">&quot;Error on get functions name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_function <span class="s2">&quot;</span><span class="nv">$row</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download function </span><span class="nv">$row</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download function </span><span class="nv">$row</span><span class="s2"> correctly (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-triggers">
<span id="commons-mariadb-download-all-triggers"></span><h3>commons_mariadb_download_all_triggers<a class="headerlink" href="#commons-mariadb-download-all-triggers" title="Permalink to this headline">¶</a></h3>
<p>Download all triggers to MARIADB_DIR/triggers directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock60'))">(Show/Hide)</a><br /><div id="hiddencodeblock60" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_triggers <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1

  commons_mariadb_count_triggers
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(_commons_mariadb_count_triggers: Found </span><span class="nv">$n_rec</span><span class="s2"> triggers.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_triggers_list <span class="o">||</span> error_handled <span class="s2">&quot;Error on get triggers name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nv">name</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[1]}&#39;</span><span class="sb">`</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_trigger <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download trigger </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download trigger </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-events">
<span id="commons-mariadb-download-all-events"></span><h3>commons_mariadb_download_all_events<a class="headerlink" href="#commons-mariadb-download-all-events" title="Permalink to this headline">¶</a></h3>
<p>Download all events to MARIADB_DIR/schedulers directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock61'))">(Show/Hide)</a><br /><div id="hiddencodeblock61" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_events <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">with_tz</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

  commons_mariadb_count_events
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(_commons_mariadb_download_all_events: Found </span><span class="nv">$n_rec</span><span class="s2"> events.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_events_list <span class="s2">&quot;view&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;Error on get events name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nv">name</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[1]}&#39;</span><span class="sb">`</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_event <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">with_tz</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download event </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download event </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-fkey">
<span id="commons-mariadb-download-fkey"></span><h3>commons_mariadb_download_fkey<a class="headerlink" href="#commons-mariadb-download-fkey" title="Permalink to this headline">¶</a></h3>
<p>Download a foreign key to MARIADB_DIR/foreign_keys directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) name of the foreign key to download.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) table name related with foreign key to download.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock62'))">(Show/Hide)</a><br /><div id="hiddencodeblock62" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_fkey <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">table</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">fkeysdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/foreign_keys&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">cname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">rtable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">rcname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ur</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">dr</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">on_delete</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">on_update</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">res</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  commons_mariadb_check_if_exist_fkey <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">res</span><span class="o">=</span><span class="nv">$?</span>
  assertNot <span class="s2">&quot;</span><span class="nv">$res</span><span class="s2">&quot;</span> <span class="s2">&quot;2&quot;</span> <span class="s2">&quot;No table name supply and found more of one foreign key with name </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">. Set table name.&quot;</span>
  assertNot <span class="s2">&quot;</span><span class="nv">$res</span><span class="s2">&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="s2">&quot;Foreign key </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> not found.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$fkeysdir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="nv">$fkeysdir</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># Retrieve data about foreign key</span>
  commons_mariadb_get_fkeys_list <span class="s2">&quot;1&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Error on retrieve data about foreign key </span><span class="nv">$name</span><span class="s2">.&quot;</span>

  <span class="nv">table</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="nv">cname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[3]}&#39;</span><span class="sb">`</span>
  <span class="nv">rtable</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[4]}&#39;</span><span class="sb">`</span>
  <span class="nv">rcname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[5]}&#39;</span><span class="sb">`</span>
  <span class="nv">ur</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[6]}&#39;</span><span class="sb">`</span>
  <span class="nv">dr</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[7]}&#39;</span><span class="sb">`</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">dr</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> x<span class="s2">&quot;RESTRICT&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">on_delete</span><span class="o">=</span><span class="s2">&quot;ON DELETE </span><span class="si">${</span><span class="nv">dr</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">ur</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> x<span class="s2">&quot;RESTRICT&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">on_update</span><span class="o">=</span><span class="s2">&quot;ON UPDATE </span><span class="si">${</span><span class="nv">dr</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># TODO: Check if create a [index_name] field automatically</span>
  <span class="c1">#       See: http://dev.mysql.com/doc/refman/5.6/en/create-table-foreign-keys.html</span>
  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$ --</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">ALTER TABLE \`</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ADD CONSTRAINT \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  FOREIGN KEY</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">cname</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">  REFERENCES \`</span><span class="si">${</span><span class="nv">rtable</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">rcname</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">  </span><span class="si">${</span><span class="nv">on_delete</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  </span><span class="si">${</span><span class="nv">on_update</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  ;</span>
<span class="s2">&quot;</span>

  <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fkeysdir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.sql&quot;</span>
  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-fkeys">
<span id="commons-mariadb-download-all-fkeys"></span><h3>commons_mariadb_download_all_fkeys<a class="headerlink" href="#commons-mariadb-download-all-fkeys" title="Permalink to this headline">¶</a></h3>
<p>Download all foreign keys to MARIADB_DIR/foreign_keys directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock63'))">(Show/Hide)</a><br /><div id="hiddencodeblock63" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_fkeys <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1

  commons_mariadb_count_fkeys
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_download_all_fkeys: Found </span><span class="nv">$n_rec</span><span class="s2"> foreign keys.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_fkeys_list <span class="s2">&quot;&quot;</span> <span class="s2">&quot;KCU.CONSTRAINT_NAME, KCU.TABLE_NAME&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on get foreign key name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nv">name</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[1]}&#39;</span><span class="sb">`</span>
      <span class="nv">tname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_fkey <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download foreign key </span><span class="nv">$name</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download foreign key </span><span class="nv">$name</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-drop-fkey">
<span id="commons-mariadb-drop-fkey"></span><h3>commons_mariadb_drop_fkey<a class="headerlink" href="#commons-mariadb-drop-fkey" title="Permalink to this headline">¶</a></h3>
<p>Drop a foreign key from database if exists.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (fkey) name of the foreign key to drop.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock64'))">(Show/Hide)</a><br /><div id="hiddencodeblock64" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_drop_fkey <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">avoid_warn</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_tname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fk</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start drop foreign key: </span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="c1"># Try to check if is present table name from filename</span>
  <span class="nv">fktname</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$name</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[a-zA-Z]+/) { print substr($0, RSTART, RLENGTH ) }&#39;</span><span class="k">)</span>
  <span class="nv">fk</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$name</span> <span class="p">|</span> awk <span class="s1">&#39;match($0, /[-]/) { print substr($0, RSTART + 1) }&#39;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># POST: fk_str contains both fk key name and fk key table.</span>
    <span class="c1">#       I check if tname in input is equal to fktname (string catch from fr_str)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fktname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;(mariadb) WARNING: Foreign key </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> is not related with table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

      <span class="nv">fk</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="c1"># error_generate &quot;Foreign key ${name} is not related with table ${tname}.&quot;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">fk</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span>

  commons_mariadb_check_if_exist_fkey <span class="s2">&quot;</span><span class="nv">$fk</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="c1"># If fktname is empty and fk_table is not available and foreign key is present</span>
  <span class="c1"># I try to retrieve table name</span>
  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$fk_is_present</span> -eq <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_fkeys_list <span class="s2">&quot;&quot;</span> <span class="s2">&quot;KCU.CONSTRAINT_NAME, KCU.TABLE_NAME&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">fk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on get data of foreign key </span><span class="nv">$fk</span><span class="s2">.&quot;</span>

    <span class="nv">tname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_drop: Dropping foreign key </span><span class="nv">$fk</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (is_present = </span><span class="nv">$is_present</span><span class="s2">).\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">      ALTER TABLE \`</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">        DROP FOREIGN KEY \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    &quot;</span>

    mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span>
    <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

    _logfile_write <span class="s2">&quot;Result = </span><span class="nv">$ans</span><span class="s2">\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">elif</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">2</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    _logfile_write <span class="se">\</span>
      <span class="s2">&quot;Table name not set and found more of one foreign key with name </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.\nSet table name and try again.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$avoid_warn</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;\nWARNING: Foreign key </span><span class="nv">$name</span><span class="s2"> not present.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">fi</span>

  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) End drop foreign key: </span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-index">
<span id="commons-mariadb-download-index"></span><h3>commons_mariadb_download_index<a class="headerlink" href="#commons-mariadb-download-index" title="Permalink to this headline">¶</a></h3>
<p>Download a index key (primary, unique, spatial) to MARIADB_DIR/indexes directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) name of the index key to download.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) table name related with index to download.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock65'))">(Show/Hide)</a><br /><div id="hiddencodeblock65" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_index <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">/.sql/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$name</span><span class="sb">`</span>
  <span class="nb">local</span> <span class="nv">indexesdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/indexes&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.sql&quot;</span>
  <span class="nb">local</span> <span class="nv">table</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">not_unique</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">itype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">icomment</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">iname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  commons_mariadb_check_if_exist_index <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Index key </span><span class="nv">$name</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> not found.&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir <span class="s2">&quot;</span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>

  <span class="c1"># Retrieve data about index key</span>
  commons_mariadb_get_indexes_list <span class="s2">&quot;all&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Error on retrieve data about index key </span><span class="nv">$name</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">.&quot;</span>

  <span class="c1"># TODO: add support to comment and index comment</span>
  <span class="nv">table</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[1]}&#39;</span><span class="sb">`</span>
  <span class="nv">not_unique</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="nv">iname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[3]}&#39;</span><span class="sb">`</span>
  <span class="nv">keys</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[4]}&#39;</span><span class="sb">`</span>
  <span class="nv">itype</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[5]}&#39;</span><span class="sb">`</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">iname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;PRIMARY&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="c1"># TODO: check if customize index_name</span>
    <span class="c1">#       See http://dev.mysql.com/doc/refman/5.6/en/alter-table.html</span>
    <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">ALTER TABLE \`</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ADD PRIMARY KEY</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">;</span>
<span class="s2">&quot;</span>

  <span class="k">else</span>

    <span class="nb">local</span> <span class="nv">itype_string</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">not_unique</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">itype_string</span><span class="o">=</span><span class="s2">&quot;UNIQUE&quot;</span>
    <span class="k">else</span>

      <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">itype</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;FULLTEXT&#39;</span> <span class="o">||</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">itype</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;SPATIAL&#39;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">itype_string</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">itype</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">fi</span>

    <span class="k">fi</span>

    <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">ALTER TABLE \`</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ADD </span><span class="si">${</span><span class="nv">itype_string</span><span class="si">}</span><span class="s2"> INDEX \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">;</span>
<span class="s2">&quot;</span>

  <span class="k">fi</span>

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-indexes">
<span id="commons-mariadb-download-all-indexes"></span><h3>commons_mariadb_download_all_indexes<a class="headerlink" href="#commons-mariadb-download-all-indexes" title="Permalink to this headline">¶</a></h3>
<p>Download all indexes to MARIADB_DIR/indexes directory.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock66'))">(Show/Hide)</a><br /><div id="hiddencodeblock66" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_indexes <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">with_pk</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">n_rec</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">iname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">itypes</span><span class="o">=</span><span class="s2">&quot;not_primary&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">with_pk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">itypes</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
  <span class="k">fi</span>

  commons_mariadb_count_indexes <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">itypes</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">n_rec</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_download_all_indexes: Found </span><span class="nv">$n_rec</span><span class="s2"> indexes.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_rec</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_get_indexes_list <span class="s2">&quot;</span><span class="si">${</span><span class="nv">itypes</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;S.TABLE_NAME,S.INDEX_NAME&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on get indexes name list.&quot;</span>

    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
    <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nv">tname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[1]}&#39;</span><span class="sb">`</span>
      <span class="nv">iname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>

      <span class="nb">unset</span> IFS
      commons_mariadb_download_index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">iname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Error on download data of index </span><span class="nv">$iname</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">else</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;Download index </span><span class="nv">$iname</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$i</span><span class="s2"> of </span><span class="nv">$n_rec</span><span class="s2">).\n&quot;</span>
      <span class="k">fi</span>
      <span class="nb">let</span> i++
      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>

    <span class="k">done</span>
    <span class="nb">unset</span> IFS

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-drop-index">
<span id="commons-mariadb-drop-index"></span><h3>commons_mariadb_drop_index<a class="headerlink" href="#commons-mariadb-drop-index" title="Permalink to this headline">¶</a></h3>
<p>Drop a index from database if exists.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (fkey) name of the index key to drop.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) Name of the table related with the index to drop.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (avoid_warn) If not empty and index doesn&#8217;t exist no warning
message are printed.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock67'))">(Show/Hide)</a><br /><div id="hiddencodeblock67" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_drop_index <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">avoid_warn</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ctype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">is_nullable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">null</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start drop index: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  commons_mariadb_check_if_exist_index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_drop: Dropping index </span><span class="nv">$name</span><span class="s2"> from table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (is_present = </span><span class="nv">$is_present</span><span class="s2">).\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;PRIMARY&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      commons_mariadb_get_indexes_list <span class="s2">&quot;all&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
        error_handled <span class="s2">&quot;Error on get index data.&quot;</span>

      <span class="nv">keys</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[4]}&#39;</span> <span class="p">|</span> tr <span class="s2">&quot;,&quot;</span> <span class="s2">&quot; &quot;</span><span class="sb">`</span>
      <span class="nv">karr</span><span class="o">=(</span><span class="nv">$keys</span><span class="o">)</span>

      <span class="k">for</span> k in <span class="si">${</span><span class="p">!karr[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>

        commons_mariadb_desc_table <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;UPPER(COLUMN_TYPE),IS_NULLABLE,UPPER(EXTRA)&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">karr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
          error_handled <span class="s2">&quot;Error on get column data of column </span><span class="si">${</span><span class="nv">arr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="nv">ctype</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[1]}&#39;</span><span class="sb">`</span>
        <span class="nv">is_nullable</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[2]}&#39;</span><span class="sb">`</span>
        <span class="nv">extra</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[3]}&#39;</span><span class="sb">`</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$extra</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;AUTO_INCREMENT&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

          _logfile_write <span class="s2">&quot;(mariadb) Modify column </span><span class="si">${</span><span class="nv">karr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2"> for remove AUTO_INCREMENT and permit drop of primary key.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

          <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$is_nullable</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;NO&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
            <span class="nv">null</span><span class="o">=</span><span class="s2">&quot;NOT NULL&quot;</span>
          <span class="k">else</span>
            <span class="nv">null</span><span class="o">=</span><span class="s2">&quot;NULL&quot;</span>
          <span class="k">fi</span>

          <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">            USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">            ALTER TABLE \`</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">            CHANGE \`</span><span class="si">${</span><span class="nv">karr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2">\` \`</span><span class="si">${</span><span class="nv">karr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2">\` </span><span class="si">${</span><span class="nv">ctype</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">null</span><span class="si">}</span><span class="s2"></span>
<span class="s2">          &quot;</span>

          mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
            error_handled <span class="s2">&quot;Error on remove AUTO_INCREMENT from column </span><span class="si">${</span><span class="nv">karr</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span><span class="si">}</span><span class="s2"> of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="k">fi</span>

      <span class="k">done</span> <span class="c1"># end for k ..</span>

      <span class="c1"># Check if keys contains AUTO_INCREMENT column.</span>

      <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">        USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">        ALTER TABLE \`</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">          DROP PRIMARY KEY</span>
<span class="s2">      &quot;</span>
    <span class="k">else</span>
      <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">        USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">        ALTER TABLE \`</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">          DROP INDEX \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">      &quot;</span>
    <span class="k">fi</span>

    mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span>
    <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

    _logfile_write <span class="s2">&quot;Result = </span><span class="nv">$ans</span><span class="s2">\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$avoid_warn</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;\nWARNING: Index </span><span class="nv">$name</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> not present.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">fi</span>

  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) End drop index: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-create-fkey-file">
<span id="commons-mariadb-create-fkey-file"></span><h3>commons_mariadb_create_fkey_file<a class="headerlink" href="#commons-mariadb-create-fkey-file" title="Permalink to this headline">¶</a></h3>
<p>Create foreign key file for compilation.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) name of the foreign key to create</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (table) Name of the table where create foreign key</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (cname) list of columns related with foreign key.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (rtable) name of the table reference</li>
<li><code class="docutils literal"><span class="pre">$5</span></code>: (rcname) list of the columns reference on foreign key.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock68'))">(Show/Hide)</a><br /><div id="hiddencodeblock68" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_create_fkey_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">table</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">rtable</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">rcname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$5</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fkeysdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/foreign_keys&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fkeysdir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.sql&quot;</span>

  <span class="c1"># Check if exists foreign_keys or create it</span>
  <span class="k">if</span> <span class="o">[[</span> ! -d <span class="si">${</span><span class="nv">fkeysdir</span><span class="si">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir -p <span class="si">${</span><span class="nv">fkeysdir</span><span class="si">}</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on create directory </span><span class="si">${</span><span class="nv">fkeysdir</span><span class="si">}</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  commons_mariadb_check_if_exist_fkey <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;A foreign key with name </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> is already present.&quot;</span>
  <span class="k">fi</span>

  <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$ --</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">ALTER TABLE \`</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ADD CONSTRAINT \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  FOREIGN KEY</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">cname</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">  REFERENCES \`</span><span class="si">${</span><span class="nv">rtable</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">rcname</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    ;</span>
<span class="s2">&quot;</span>

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$content</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on write file </span><span class="nv">$f</span><span class="s2">.&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Create foreign key </span><span class="nv">$name</span><span class="s2"> (file </span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-create-fkey-file">
<span id="id1"></span><h3>commons_mariadb_create_fkey_file<a class="headerlink" href="#commons-mariadb-create-fkey-file" title="Permalink to this headline">¶</a></h3>
<p>Create index file for compilation.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) name of the index to create</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (table) name of the table where create index.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (keys) list of columns of the index.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (itable) for particolar index could be contains
&#8220;UNIQUE&#8221; | &#8220;FULLTEXT&#8221; | &#8220;SPATIAL&#8221;</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock69'))">(Show/Hide)</a><br /><div id="hiddencodeblock69" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_create_index_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">table</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">itype</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">indexesdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MARIADB_DIR</span><span class="si">}</span><span class="s2">/indexes&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.sql&quot;</span>

  <span class="c1"># Check if exists indexes or create it</span>
  <span class="k">if</span> <span class="o">[[</span> ! -d <span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir -p <span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on create directory </span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  commons_mariadb_check_if_exist_index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    error_generate <span class="s2">&quot;An index with name </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2"> is already present.&quot;</span>
  <span class="k">fi</span>

  <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$ --</span>
<span class="s2">USE \`DB_NAME\`;</span>
<span class="s2">ALTER TABLE \`</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">  ADD </span><span class="si">${</span><span class="nv">itype</span><span class="si">}</span><span class="s2"> INDEX \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    (</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    ;</span>
<span class="s2">&quot;</span>

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$content</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on write file </span><span class="nv">$f</span><span class="s2">.&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Create index </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2"> (file </span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="se">\</span>
    <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-get-table-def">
<span id="commons-mariadb-get-table-def"></span><h3>commons_mariadb_get_table_def<a class="headerlink" href="#commons-mariadb-get-table-def" title="Permalink to this headline">¶</a></h3>
<p>Create table definition syntax and store it on TABLE_DEF variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (name) name of the table</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock70'))">(Show/Hide)</a><br /><div id="hiddencodeblock70" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_get_table_def <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;CREATE TABLE IF NOT EXISTS \`</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">\` (\n&quot;</span>
  <span class="nb">local</span> <span class="nv">row_cname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">row_is_nullable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">row_ctype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">row_ckey</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">row_cextra</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">row_default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">cname</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">is_nullable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ctype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">cextra</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">counter</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">min_col_size</span><span class="o">=</span>19
  <span class="nb">local</span> <span class="nv">pre_spaces</span><span class="o">=</span>4
  <span class="nb">local</span> <span class="nv">engine</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">charset</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">has_pk</span><span class="o">=</span>0

  commons_mariadb_exist_table <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  commons_mariadb_desc_table <span class="s2">&quot;</span><span class="nv">$tname</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
  <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

    row_name<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[1]}&#39;</span><span class="sb">`</span>
    row_is_nullable<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[2]}&#39;</span><span class="sb">`</span>
    row_ctype<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[3]}&#39;</span><span class="sb">`</span>
    row_ckey<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[4]}&#39;</span><span class="sb">`</span>
    row_cextra<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[5]}&#39;</span> <span class="p">|</span> xargs<span class="sb">`</span>
    row_default<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[6]}&#39;</span> <span class="p">|</span> xargs<span class="sb">`</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">row_name</span><span class="p">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> -ge <span class="nv">$min_col_size</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">min_col_size</span><span class="o">=</span><span class="k">$((</span><span class="si">${#</span><span class="nv">row_name</span><span class="p">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>
    <span class="k">fi</span>

    <span class="nb">let</span> counter++

  <span class="k">done</span>
  <span class="nb">unset</span> IFS

  <span class="c1"># Check if is present a primary key</span>
  commons_mariadb_count_indexes <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;primary&quot;</span>
  <span class="nv">has_pk</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">for</span> row_id in <span class="si">${</span><span class="p">!row_name[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>

    <span class="nb">let</span> counter--

    <span class="nv">cname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_name</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">is_nullable</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_is_nullable</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">ctype</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_ctype</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">ckey</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_ctype</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">cextra</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_cextra</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">row_default</span><span class="p">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nb">local</span> <span class="nv">cname_str</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    get_space_str <span class="s2">&quot;cname_str&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">min_col_size</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">cname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">pre_spaces</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}${</span><span class="nv">cname_str</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ctype</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Set NOT NULL section if column is not nullable</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">is_nullable</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2"> NOT NULL&quot;</span>
    <span class="k">fi</span>

    <span class="c1"># Set default section</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">default</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;NULL&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">default</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;CURRENT_TIMESTAMP&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2"> DEFAULT </span><span class="si">${</span><span class="nv">default</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">else</span>
        <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2"> DEFAULT &#39;</span><span class="si">${</span><span class="nv">default</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">cextra</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">cextra</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$counter</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">,\n&quot;</span>
    <span class="k">else</span>
      <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="c1"># Clean field values</span>
    row_name<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>
    row_is_nullable<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>
    row_ctype<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>
    row_ckey<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>
    row_cextra<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>
    row_default<span class="o">[</span><span class="si">${</span><span class="nv">row_id</span><span class="si">}</span><span class="o">]=</span><span class="s2">&quot;&quot;</span>

  <span class="k">done</span>

  <span class="c1"># Add primary key</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$has_pk</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">,\n&quot;</span>
    commons_mariadb_get_indexes_list <span class="s2">&quot;primary&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot;|&quot;); print a[4]}&#39;</span><span class="sb">`</span>
    <span class="nb">local</span> <span class="nv">pkey</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    get_space_str <span class="s2">&quot;pkey&quot;</span> <span class="s2">&quot;0&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">pre_spaces</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">pkey</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pkey</span><span class="si">}</span><span class="s2">PRIMARY KEY(</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}${</span><span class="nv">pkey</span><span class="si">}</span><span class="s2">\n&quot;</span>
  <span class="k">else</span>
    <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">\n&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># Add close round bracket and engine</span>
  commons_mariadb_get_tables_list <span class="s2">&quot;1&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Error on retrieve table data&quot;</span>
  <span class="nv">engine</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[2]}&#39;</span><span class="sb">`</span>
  <span class="nv">charset</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$_mariadb_ans</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[5]}&#39;</span><span class="sb">`</span>

  <span class="nv">def</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">) ENGINE=</span><span class="si">${</span><span class="nv">engine</span><span class="si">}</span><span class="s2"> DEFAULT CHARSET=</span><span class="si">${</span><span class="nv">charset</span><span class="si">}</span><span class="s2">;\n&quot;</span>

  <span class="nv">TABLE_DEF</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">def</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="nb">unset</span> row_name
  <span class="nb">unset</span> row_is_nullable
  <span class="nb">unset</span> row_ctype
  <span class="nb">unset</span> row_ckey
  <span class="nb">unset</span> row_cextra
  <span class="nb">unset</span> row_default

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-download-all-tables">
<span id="commons-mariadb-download-all-tables"></span><h3>commons_mariadb_download_all_tables<a class="headerlink" href="#commons-mariadb-download-all-tables" title="Permalink to this headline">¶</a></h3>
<p>Extract all tables definition and write its to a target file.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) file name path where save tables schema.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) download only schema of a particular table.
Optional parameter.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock71'))">(Show/Hide)</a><br /><div id="hiddencodeblock71" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_download_all_tables <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">n_tables</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">counter</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">tname_list</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">tb_added</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">file_exists</span><span class="o">=</span><span class="nb">false</span>
  <span class="nb">local</span> <span class="nv">table_is_present</span><span class="o">=</span>0

  <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 1

  <span class="c1"># Check if file exists</span>
  <span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">file_exists</span><span class="o">=</span><span class="nb">true</span>
  <span class="k">fi</span>

  <span class="c1"># Check if directory must be created</span>
  <span class="k">if</span> <span class="o">[[</span> ! -d <span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Try to create directory</span>
    mkdir -p <span class="k">$(</span>dirname <span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="k">)</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on create directory </span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="k">)</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_download_all_tables: File </span><span class="nv">$f</span><span class="s2"> exists: </span><span class="nv">$file_exists</span><span class="s2">.)\n&quot;</span>

  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mariadb_count_tables
    <span class="nv">n_tables</span><span class="o">=</span><span class="nv">$?</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$n_tables</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="nb">echo</span> -en <span class="s2">&quot;No tables available.\n&quot;</span>

    <span class="k">else</span>

      commons_mariadb_get_tables_list <span class="s2">&quot;1&quot;</span> <span class="o">||</span> <span class="se">\</span>
        error_handled <span class="s2">&quot;Error on retrieve list of tables.&quot;</span>

      <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
      <span class="k">for</span> row in <span class="nv">$_mariadb_ans</span> <span class="p">;</span> <span class="k">do</span>

        tname_list<span class="o">[</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="o">]=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> awk <span class="s1">&#39;{split($0,a,&quot; &quot;); print a[1]}&#39;</span><span class="sb">`</span>

        <span class="nb">let</span> counter++

      <span class="k">done</span>
      <span class="nb">unset</span> IFS

      <span class="k">for</span> t_id in <span class="si">${</span><span class="p">!tname_list[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>

        <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname_list</span><span class="p">[</span><span class="si">${</span><span class="nv">t_id</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Table </span><span class="nv">$t_id</span><span class="s2">: </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.\n&quot;</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$file_exists</span> <span class="o">&amp;&amp;</span> <span class="nv">$file_exists</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
          <span class="c1"># Check if table definition is already present.</span>

          <span class="nv">table_is_present</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$f</span> <span class="p">|</span> grep <span class="s2">&quot;CREATE TABLE IF NOT EXISTS \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`&quot;</span> <span class="p">|</span> wc -l<span class="k">)</span>
          <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Table </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> is present: </span><span class="si">${</span><span class="nv">table_is_present</span><span class="si">}</span><span class="s2">.&quot;</span>

          <span class="k">if</span> <span class="o">[[</span> <span class="nv">$table_is_present</span> -eq <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

            commons_mariadb_get_table_def <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
              error_handled <span class="s2">&quot;Error on retrieve definition of table </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.&quot;</span>

            <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">out</span><span class="si">}${</span><span class="nv">TABLE_DEF</span><span class="si">}</span><span class="s2">\n&quot;</span>

            <span class="nb">let</span> tb_added++

          <span class="k">fi</span>

        <span class="k">else</span>

            commons_mariadb_get_table_def <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
              error_handled <span class="s2">&quot;Error on retrieve definition of table </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.&quot;</span>

            <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">out</span><span class="si">}${</span><span class="nv">TABLE_DEF</span><span class="si">}</span><span class="s2">\n&quot;</span>

            <span class="nb">let</span> tb_added++

        <span class="k">fi</span>

      <span class="k">done</span>

      <span class="k">if</span> <span class="o">[[</span> <span class="nv">$file_exists</span> <span class="o">&amp;&amp;</span> <span class="nv">$file_exists</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$tb_added</span> -eq <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

          <span class="nb">echo</span> -en <span class="s2">&quot;All tables are already present on file </span><span class="nv">$f</span><span class="s2">. Nothing to do.\n&quot;</span>

        <span class="k">else</span>

          <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$f</span>
          <span class="nb">echo</span> -en <span class="s2">&quot;Added </span><span class="si">${</span><span class="nv">tb_added</span><span class="si">}</span><span class="s2"> tables to file </span><span class="nv">$f</span><span class="s2">.\n&quot;</span>

        <span class="k">fi</span>

      <span class="k">else</span>

        <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$ --</span>

<span class="si">${</span><span class="nv">out</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

      <span class="k">fi</span>

    <span class="k">fi</span>

  <span class="k">else</span>

    commons_mariadb_get_table_def <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_handled <span class="s2">&quot;Error on create definition of table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">.&quot;</span>

    <span class="nv">out</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">-- \$Id\$ --</span>

<span class="si">${</span><span class="nv">TABLE_DEF</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$out</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span>

  <span class="k">fi</span>

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-drop-trigger">
<span id="commons-mariadb-drop-trigger"></span><h3>commons_mariadb_drop_trigger<a class="headerlink" href="#commons-mariadb-drop-trigger" title="Permalink to this headline">¶</a></h3>
<p>Drop a trigger from database if exists.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (fkey) name of the trigger to drop.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (tname) Name of the table related with the trigger to drop.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (avoid_warn) If not empty and trigger doesn&#8217;t exist no warning
message are printed.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock72'))">(Show/Hide)</a><br /><div id="hiddencodeblock72" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_drop_trigger <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">avoid_warn</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ctype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">is_nullable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">null</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start drop trigger: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  commons_mariadb_check_if_exist_trigger <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_drop_trigger: Dropping trigger </span><span class="nv">$name</span><span class="s2"> from table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (is_present = </span><span class="nv">$is_present</span><span class="s2">).\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">      DROP TRIGGER \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    &quot;</span>
    mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span>
    <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

    _logfile_write <span class="s2">&quot;Result = </span><span class="nv">$ans</span><span class="s2">\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$avoid_warn</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;\nWARNING: Trigger </span><span class="nv">$name</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> not present.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">fi</span>

  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) End drop trigger: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-drop-event">
<span id="commons-mariadb-drop-event"></span><h3>commons_mariadb_drop_event<a class="headerlink" href="#commons-mariadb-drop-event" title="Permalink to this headline">¶</a></h3>
<p>Drop a event from database if exists.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (ename) name of the event to drop.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (avoid_warn) If not empty and event doesn&#8217;t exist no warning
message are printed.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock73'))">(Show/Hide)</a><br /><div id="hiddencodeblock73" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_drop_trigger <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">tname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">avoid_warn</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ctype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">is_nullable</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">null</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  _logfile_write <span class="s2">&quot;(mariadb) Start drop trigger: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  commons_mariadb_check_if_exist_trigger <span class="s2">&quot;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">is_present</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mariadb_drop_trigger: Dropping trigger </span><span class="nv">$name</span><span class="s2"> from table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> (is_present = </span><span class="nv">$is_present</span><span class="s2">).\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$is_present</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">      USE \`</span><span class="si">${</span><span class="nv">MARIADB_DB</span><span class="si">}</span><span class="s2">\` ;</span>
<span class="s2">      DROP TRIGGER \`</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\`</span>
<span class="s2">    &quot;</span>
    mysql_cmd_4var <span class="s2">&quot;MYSQL_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span>
    <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

    _logfile_write <span class="s2">&quot;Result = </span><span class="nv">$ans</span><span class="s2">\n</span><span class="nv">$MYSQL_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">else</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$avoid_warn</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      _logfile_write <span class="s2">&quot;\nWARNING: Trigger </span><span class="nv">$name</span><span class="s2"> on table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2"> not present.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">fi</span>

  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mariadb) End drop trigger: </span><span class="nv">$name</span><span class="s2"> (table </span><span class="si">${</span><span class="nv">tname</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mariadb-show-gvars">
<span id="commons-mariadb-show-gvars"></span><h3>commons_mariadb_show_gvars<a class="headerlink" href="#commons-mariadb-show-gvars" title="Permalink to this headline">¶</a></h3>
<p>Retrieve global variables.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (filter) filter apply to SELECT of variables.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock74'))">(Show/Hide)</a><br /><div id="hiddencodeblock74" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mariadb_show_gvars <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">filter</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">and_where</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">filter</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">and_where</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">     WHERE LOWER(VARIABLE_NAME)</span>
<span class="s2">     LIKE CONCAT(&#39;%&#39;, LOWER(&#39;</span><span class="si">${</span><span class="nv">filter</span><span class="si">}</span><span class="s2">&#39;), &#39;%&#39;)&quot;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">    SELECT CONCAT_WS(&#39;|&#39;, LOWER(VARIABLE_NAME),COALESCE(VARIABLE_VALUE, &#39;&#39;))</span>
<span class="s2">    FROM INFORMATION_SCHEMA.GLOBAL_VARIABLES</span>
<span class="s2">    </span><span class="si">${</span><span class="nv">and_where</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  &quot;</span>

  mysql_cmd_4var <span class="s2">&quot;_mariadb_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Geaaru.<br/>
      Last updated on Jun 05, 2017.<br/>
    </p>
  </div>
</footer>
  </body>
</html>