<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Mongo Module &#8212; Database Release Manager</title>
    <link rel="stylesheet" href="static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/dbrm.css" type="text/css" />
    <link rel="stylesheet" href="static/bootswatch-3.3.6/superhero/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Commons API" href="common.html" />
    <link rel="prev" title="Oracle Module" href="oracle.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Database Release Manager</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="dbm.html">Dbm Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="logfile.html">Logfile Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="mariadb.html">MariaDB Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="oracle.html">Oracle Module</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mongo Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="common.html">Commons API</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql.html">Mysql API</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqlplus.html">Sqlplus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="psql.html">Psql API</a></li>
<li class="toctree-l1"><a class="reference internal" href="commons_mariadb.html">Commons Mariadb API</a></li>
<li class="toctree-l1"><a class="reference internal" href="commons_oracle.html">Commons Oracle API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Mongo Module</a><ul>
<li><a class="reference internal" href="#variables">Variables</a></li>
<li><a class="reference internal" href="#project-folder-structure">Project Folder Structure</a><ul>
<li><a class="reference internal" href="#index-naming-convention">Index Naming Convention</a></li>
</ul>
</li>
<li><a class="reference internal" href="#commands">Commands</a><ul>
<li><a class="reference internal" href="#mongo-version">mongo version</a></li>
<li><a class="reference internal" href="#mongo-test-connection">mongo test_connection</a><ul>
<li><a class="reference internal" href="#test-connection-options">test_connection options:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mongo-shell">mongo shell</a><ul>
<li><a class="reference internal" href="#shell-options">shell options:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mongo-compile">mongo compile</a><ul>
<li><a class="reference internal" href="#compile-options">compile options:</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#mongo-set-auth-var">mongo_set_auth_var</a></li>
<li><a class="reference internal" href="#mongo-file">mongo_file</a></li>
<li><a class="reference internal" href="#mongo-file-initrc">mongo_file_initrc</a></li>
<li><a class="reference internal" href="#mongo-cmd-4var">mongo_cmd_4var</a></li>
</ul>
</li>
<li><a class="reference internal" href="#commons-mongo-api">Commons Mongo API</a><ul>
<li><a class="reference internal" href="#commons-mongo-check-client">commons_mongo_check_client</a></li>
<li><a class="reference internal" href="#commons-mongo-check-vars">commons_mongo_check_vars</a></li>
<li><a class="reference internal" href="#commons-mongo-check-connection">commons_mongo_check_connection</a></li>
<li><a class="reference internal" href="#commons-mongo-shell">commons_mongo_shell</a></li>
<li><a class="reference internal" href="#commons-mongo-compile-file">commons_mongo_compile_file</a></li>
<li><a class="reference internal" href="#commons-mongo-get-indexes-list">commons_mongo_get_indexes_list</a></li>
<li><a class="reference internal" href="#commons-mongo-stats">commons_mongo_stats</a></li>
<li><a class="reference internal" href="#commons-mongo-create-index-file">commons_mongo_create_index_file</a></li>
<li><a class="reference internal" href="#commons-mongo-download-index">commons_mongo_download_index</a></li>
<li><a class="reference internal" href="#commons-mongo-download-all-indexes">commons_mongo_download_all_indexes</a></li>
<li><a class="reference internal" href="#commons-mongo-drop-index">commons_mongo_drop_index</a></li>
<li><a class="reference internal" href="#commons-mongo-compile-idx">commons_mongo_compile_idx</a></li>
<li><a class="reference internal" href="#commons-mongo-compile-all-from-dir">commons_mongo_compile_all_from_dir</a></li>
<li><a class="reference internal" href="#commons-mongo-compile-all-idxs">commons_mongo_compile_all_idxs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="oracle.html" title="Previous Chapter: Oracle Module"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Oracle Module</span>
    </a>
  </li>
  <li>
    <a href="common.html" title="Next Chapter: Commons API"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Commons API &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row" >
    <div class="col-md-12 content">
      
  <div class="section" id="mongo-module">
<span id="mongo-module"></span><h1>Mongo Module<a class="headerlink" href="#mongo-module" title="Permalink to this headline">¶</a></h1>
<p>A series of functions used for interact directly with <code class="docutils literal"><span class="pre">mongo</span></code> client program.</p>
<div class="section" id="variables">
<span id="variables"></span><h2>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MONGO_CLIENT</span></code></td>
<td>Path of mongo client.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MONGO_EXTRA_OPTIONS</span></code></td>
<td>Extra options for mongo client.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MONGO_USER</span></code></td>
<td>Contains Username to use on connection.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MONGO_PWD</span></code></td>
<td>Contains password to use on connection.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MONGO_DB</span></code></td>
<td>Contains database name to use on connection</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MONGO_DIR</span></code></td>
<td>Contains path of directory where found project script.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MONGO_AUTHDB</span></code></td>
<td>Contains authentication database to use on connection.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MONGO_INITRC</span></code></td>
<td>Contains path of the file with content to execute before
target commands.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="project-folder-structure">
<span id="project-folder-structure"></span><h2>Project Folder Structure<a class="headerlink" href="#project-folder-structure" title="Permalink to this headline">¶</a></h2>
<p>An initialized project folder is composed by these directories:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">creation_scripts</span></code>: this directory contains initial DDL script for create all
collection of the project with master data types.
This directory could be used at begin of the project for the first
release, in the next release is then used <em>update_scripts</em> directory
that contains script for upgrade project and trace changes between
releasees.</li>
<li><code class="docutils literal"><span class="pre">dbrm-profiles</span></code>: if profiles are enable contains all configuration files for
different environment (dev, test, prod, etc.). This directory could be with
a different name and depend of value present of DRM_PROFILES_PATH variable.</li>
<li><code class="docutils literal"><span class="pre">indexes</span></code>: this directory contains files with all indexes of the database.
Special index _id could be not present.</li>
<li><code class="docutils literal"><span class="pre">update_scripts</span></code>: this directory is used for store scripts with changes on database between
first release and next releases.</li>
<li><code class="docutils literal"><span class="pre">schemas</span></code>: optinal directory that could be contains database schema of the
collections for example done by Dia tool.</li>
</ul>
<p>Under project directory normally is also available <code class="docutils literal"><span class="pre">dbrm.conf</span></code> file with main configuration
options of the project and <code class="docutils literal"><span class="pre">dbrm.db</span></code> sqlite database used by <code class="docutils literal"><span class="pre">dbrm</span></code> for the project.</p>
<div class="section" id="index-naming-convention">
<span id="index-naming-convention"></span><h3>Index Naming Convention<a class="headerlink" href="#index-naming-convention" title="Permalink to this headline">¶</a></h3>
<p>Indexes created with <em>create</em> command or downloaded with <em>download</em> command has this
naming convention:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">filename</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Collection</span> <span class="n">Name</span><span class="o">&gt;</span> <span class="s1">&#39;.&#39;</span> <span class="o">&lt;</span><span class="n">Index</span> <span class="n">Name</span><span class="o">&gt;</span> <span class="s1">&#39;.js&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="commands">
<span id="commands"></span><h2>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mongo-version">
<span id="mongo-version"></span><h3>mongo version<a class="headerlink" href="#mongo-version" title="Permalink to this headline">¶</a></h3>
<p>Show version of mongo module</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>  <span class="nv">$#</span> dbrm mongo version
  Version: 0.1.0
</pre></div>
</div>
</div>
<div class="section" id="mongo-test-connection">
<span id="mongo-test-connection"></span><h3>mongo test_connection<a class="headerlink" href="#mongo-test-connection" title="Permalink to this headline">¶</a></h3>
<p>Test connection to database of the active profile or active configuration.</p>
<div class="section" id="test-connection-options">
<span id="test-connection-options"></span><h4>test_connection options:<a class="headerlink" href="#test-connection-options" title="Permalink to this headline">¶</a></h4>
<p>This options are generic option for handle connection and are avilable on different
commands.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">-P</span> <span class="pre">MONGO_PWD</span></code>: Override MONGO_PWD variable.</li>
<li><code class="docutils literal"><span class="pre">-U</span> <span class="pre">MONGO_USER</span></code>: Override MONGO_USER with username of the connection.</li>
<li><code class="docutils literal"><span class="pre">-H</span> <span class="pre">MONGO_HOST</span></code>: Override MONGO_HOST with host of the database.</li>
<li><code class="docutils literal"><span class="pre">-D</span> <span class="pre">MONGO_DIR</span></code>: Override MONGO_DIR directory where save/retrieve script/functions, etc.</li>
<li><code class="docutils literal"><span class="pre">--database</span> <span class="pre">db</span></code>: Override MONGO_DB variable for database name.</li>
<li><code class="docutils literal"><span class="pre">--conn-options</span> <span class="pre">opts</span></code>: Override MONGO_EXTRA_OPTIONS variable for enable extra
connection options.</li>
<li><code class="docutils literal"><span class="pre">--authdb</span> <span class="pre">db</span></code>: Override MONGO_AUTHDB variable for set authentication database.</li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span>  <span class="nv">$#</span> dbrm mongo test_connection
  Connected to database1 with user icon correctly.
</pre></div>
</div>
</div>
</div>
<div class="section" id="mongo-shell">
<span id="mongo-shell"></span><h3>mongo shell<a class="headerlink" href="#mongo-shell" title="Permalink to this headline">¶</a></h3>
<p>Enter on mongo shell of the active profile or active configuration.</p>
<div class="section" id="shell-options">
<span id="shell-options"></span><h4>shell options:<a class="headerlink" href="#shell-options" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">-P</span> <span class="pre">MONGO_PWD</span></code>: Override MONGO_PWD variable.</li>
<li><code class="docutils literal"><span class="pre">-U</span> <span class="pre">MONGO_USER</span></code>: Override MONGO_USER with username of the connection.</li>
<li><code class="docutils literal"><span class="pre">-H</span> <span class="pre">MONGO_HOST</span></code>: Override MONGO_HOST with host of the database.</li>
<li><code class="docutils literal"><span class="pre">-D</span> <span class="pre">MONGO_DIR</span></code>: Override MONGO_DIR directory where save/retrieve script/functions, etc.</li>
<li><code class="docutils literal"><span class="pre">--database</span> <span class="pre">db</span></code>: Override MONGO_DB variable for database name.</li>
<li><code class="docutils literal"><span class="pre">--conn-options</span> <span class="pre">opts</span></code>: Override MONGO_EXTRA_OPTIONS variable for enable extra
connection options.</li>
<li><code class="docutils literal"><span class="pre">--authdb</span> <span class="pre">db</span></code>: Override MONGO_AUTHDB variable for set authentication database.</li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span>  <span class="nv">$#</span> dbrm mongo shell
  MongoDB shell version v3.4.3
  connecting to: mongodb://192.168.1.200:27018/database1
  MongoDB server version: 3.2.11
  WARNING: shell and server versions <span class="k">do</span> not match
  mongos&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="mongo-compile">
<span id="mongo-compile"></span><h3>mongo compile<a class="headerlink" href="#mongo-compile" title="Permalink to this headline">¶</a></h3>
<p>Compile files to active database.</p>
<p>From command line is visible result of compilation but a more detailed trace is save on logfile defined on <code class="docutils literal"><span class="pre">LOGFILE</span></code> variable
(default <code class="docutils literal"><span class="pre">dbrm.log</span></code>).</p>
<div class="section" id="compile-options">
<span id="compile-options"></span><h4>compile options:<a class="headerlink" href="#compile-options" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">-P</span> <span class="pre">MONGO_PWD</span></code>: Override MONGO_PWD variable.</li>
<li><code class="docutils literal"><span class="pre">-U</span> <span class="pre">MONGO_USER</span></code>: Override MONGO_USER with username of the connection.</li>
<li><code class="docutils literal"><span class="pre">-H</span> <span class="pre">MONGO_HOST</span></code>: Override MONGO_HOST with host of the database.</li>
<li><code class="docutils literal"><span class="pre">-D</span> <span class="pre">MONGO_DIR</span></code>: Override MONGO_DIR directory where save/retrieve script/functions, etc.</li>
<li><code class="docutils literal"><span class="pre">--database</span> <span class="pre">db</span></code>: Override MONGO_DB variable for database name.</li>
<li><code class="docutils literal"><span class="pre">--conn-options</span> <span class="pre">opts</span></code>: Override MONGO_EXTRA_OPTIONS variable for enable extra
connection options.</li>
<li><code class="docutils literal"><span class="pre">--authdb</span> <span class="pre">db</span></code>: Override MONGO_AUTHDB variable for set authentication database.</li>
<li><code class="docutils literal"><span class="pre">--file</span> <span class="pre">FILE</span></code>: Compile a particular file. (Use ABS Path or relative path from current dir.)</li>
</ul>
<p>For argument with value if it isn't passed value argument is ignored.</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>  <span class="nv">$#</span>  dbrm mongo compile --file test.js
  <span class="o">(</span>mongo<span class="o">)</span> Start compilation <span class="o">(</span>file test.js<span class="o">)</span>: File test.js
  <span class="o">(</span>mongo<span class="o">)</span> End compilation <span class="o">(</span>file test.js, <span class="nv">result</span> <span class="o">=</span>&gt; 0<span class="o">)</span>: File test.js
  Compile operation successfull.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="api">
<span id="api"></span><h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mongo-set-auth-var">
<span id="mongo-set-auth-var"></span><h3>mongo_set_auth_var<a class="headerlink" href="#mongo-set-auth-var" title="Permalink to this headline">¶</a></h3>
<p>Set mongo_auth variable with arguments to use with mongo client program.
Valorize options like: -u username --password=pwd database.</p>
<p>Currently, authentication with certificate is not yet supported.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (db) Name of the schema to use</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (user) User to use on authentication</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (pwd) Password to use on authentication.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (host) Optionally host of the database server.</li>
<li><code class="docutils literal"><span class="pre">$5</span></code>: (auth_db) Optionally authentication database to use on authentication.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: always</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock167'))">(Show/Hide)</a><br /><div id="hiddencodeblock167" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>mongo_set_auth_var <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">db</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">user</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">pwd</span><span class="o">=</span><span class="nv">$3</span>
  <span class="nb">local</span> <span class="nv">host</span><span class="o">=</span><span class="nv">$4</span>
  <span class="nb">local</span> <span class="nv">auth_db</span><span class="o">=</span><span class="nv">$5</span>

  <span class="c1"># TODO: check if use --host and --port instead of host:port/db</span>


  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">auth_db</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">mongo_auth</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">mongo_auth</span><span class="si">}</span><span class="s2"> --authenticationDatabase </span><span class="si">${</span><span class="nv">auth_db</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># TODO: Check of pass username and password with single quote</span>
  <span class="nv">mongo_auth</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">db</span><span class="si">}</span><span class="s2"> --username=</span><span class="nv">$user</span><span class="s2"> --password=</span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">mongo_auth</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Use </span><span class="si">${</span><span class="nv">mongo_auth</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="mongo-file">
<span id="mongo-file"></span><h3>mongo_file<a class="headerlink" href="#mongo-file" title="Permalink to this headline">¶</a></h3>
<p>Compile a file and save ouput to input variable.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (var) Name of the variable where is save output command.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (f) File to compile.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock168'))">(Show/Hide)</a><br /><div id="hiddencodeblock168" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>mongo_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MONGO_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(mongo_file) Try compile file </span><span class="nv">$f</span><span class="s2"> with options </span><span class="nv">$opts</span><span class="s2"> </span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mongo_auth</span><span class="s2">.\n&quot;</span>

  <span class="nv">v</span><span class="o">=</span><span class="k">$(</span><span class="nb">eval</span> <span class="nv">$MONGO_CLIENT</span> <span class="nv">$opts</span> <span class="nv">$MONGO_EXTRA_OPTIONS</span> <span class="nv">$mongo_auth</span> <span class="nv">$f</span> 2&gt;<span class="p">&amp;</span>1<span class="k">)</span>
  <span class="nv">result</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(mongo_file) Compile </span><span class="nv">$f</span><span class="s2"> =&gt; </span><span class="nv">$v</span><span class="s2"> (</span><span class="nv">$result</span><span class="s2">).\n&quot;</span>

  <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">=\$v&quot;</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="mongo-file-initrc">
<span id="mongo-file-initrc"></span><h3>mongo_file_initrc<a class="headerlink" href="#mongo-file-initrc" title="Permalink to this headline">¶</a></h3>
<p>Compile a file and save ouput to input variable.
File is loaded on memory before execute content, so it isn't ideal
for bigfile.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (var) Name of the variable where is save output command.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (f) File to compile.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (initrc) Path of file with commons commands to execute before
compile file content. Is an alternative to .mongorc.js file.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock169'))">(Show/Hide)</a><br /><div id="hiddencodeblock169" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>mongo_file_initrc <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">initrc</span><span class="o">=</span><span class="nv">$3</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">init_commands</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">commands</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MONGO_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$initrc</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">init_commands</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat <span class="nv">$initrc</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="nv">commands</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat <span class="nv">$f</span><span class="k">)</span><span class="s2">&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(mongo_file) Try compile file </span><span class="nv">$f</span><span class="s2"> with options </span><span class="nv">$opts</span><span class="s2"> </span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mongo_auth</span><span class="s2">.\n&quot;</span>

  <span class="nv">v</span><span class="o">=</span><span class="k">$(</span><span class="nv">$MONGO_CLIENT</span> <span class="nv">$opts</span> <span class="nv">$MONGO_EXTRA_OPTIONS</span> <span class="nv">$mongo_auth</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">$init_commands</span>
<span class="s">$commands</span>
<span class="s">EOF</span>
<span class="k">)</span>
  <span class="nv">result</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(mongo_file) Compile </span><span class="nv">$f</span><span class="s2"> =&gt; </span><span class="nv">$v</span><span class="s2"> (</span><span class="nv">$result</span><span class="s2">).\n&quot;</span>

  <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">=\$v&quot;</span>

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="mongo-cmd-4var">
<span id="mongo-cmd-4var"></span><h3>mongo_cmd_4var<a class="headerlink" href="#mongo-cmd-4var" title="Permalink to this headline">¶</a></h3>
<p>Execute an input statement on configured schema.</p>
<p><em>Variables Used</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">MONGO_CLIENT</span></code>: Path of mongo client.</li>
</ul>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (var) Name of the variable where is save output command.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (cmd) Command to execute.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (rm_lf) If string length is not zero than from output command are remove LF.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock170'))">(Show/Hide)</a><br /><div id="hiddencodeblock170" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>mongo_cmd_4var <span class="o">()</span> <span class="o">{</span>

  <span class="nb">set</span> -f
  <span class="nb">local</span> <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">initrc</span><span class="o">=</span><span class="nv">$3</span>
  <span class="nb">local</span> <span class="nv">rm_lf</span><span class="o">=</span><span class="nv">$4</span>
  <span class="nb">local</span> <span class="nv">v</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">init_commands</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">commands</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MONGO_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2">&quot;</span> !<span class="o">=</span> *--quiet* <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;--quiet&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$initrc</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">init_commands</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat <span class="nv">$initrc</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(mongo_cmd_4var) Connection options </span><span class="nv">$opts</span><span class="s2"> </span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mongo_auth</span><span class="s2">.\n&quot;</span>


  <span class="nv">v</span><span class="o">=</span><span class="k">$(</span><span class="nv">$MONGO_CLIENT</span> <span class="nv">$opts</span> <span class="nv">$MONGO_EXTRA_OPTIONS</span> <span class="nv">$mongo_auth</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">$init_commands</span>
<span class="s">$cmd</span>
<span class="s">EOF</span>
<span class="k">)</span>
  <span class="nv">result</span><span class="o">=</span><span class="nv">$?</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2"> ==&gt; </span><span class="nv">$v</span><span class="s2"> (</span><span class="nv">$result</span><span class="s2">)\n&quot;</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$result</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;</span><span class="nv">$v</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$rm_lf</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="nv">v</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$v</span> <span class="p">|</span> sed <span class="s1">&#39;s/\n//g&#39;</span><span class="sb">`</span>

    <span class="k">fi</span>

  <span class="k">fi</span>

  <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">=\$v&quot;</span>

  <span class="nb">set</span> +f

  <span class="k">return</span> <span class="nv">$result</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
</div>
<div class="section" id="commons-mongo-api">
<span id="commons-mongo-api"></span><h2>Commons Mongo API<a class="headerlink" href="#commons-mongo-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="commons-mongo-check-client">
<span id="commons-mongo-check-client"></span><h3>commons_mongo_check_client<a class="headerlink" href="#commons-mongo-check-client" title="Permalink to this headline">¶</a></h3>
<p>Check if mongo client program is present on system.
If present <code class="docutils literal"><span class="pre">MONGO_CLIENT</span></code> variable with abs path is set.
Function check if it is set <code class="docutils literal"><span class="pre">mongo</span></code> variable:</p>
<ul class="simple">
<li>if it is not set then try to find path through 'which' program</li>
<li>if it is set then check if path is correct and program exists.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock171'))">(Show/Hide)</a><br /><div id="hiddencodeblock171" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_check_client <span class="o">()</span> <span class="o">{</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="c1"># POST: mongo variable not set</span>
    <span class="nv">tmp</span><span class="o">=</span><span class="sb">`</span>which mongo 2&gt; /dev/null<span class="sb">`</span>
    <span class="nv">var</span><span class="o">=</span><span class="nv">$?</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$var</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Use mongo: </span><span class="nv">$tmp</span><span class="s2">\n&quot;</span>

      <span class="nv">MONGO_CLIENT</span><span class="o">=</span><span class="nv">$tmp</span>

      <span class="nb">unset</span> tmp

    <span class="k">else</span>

      error_generate <span class="s2">&quot;mongo program not found&quot;</span>

      <span class="k">return</span> 1

    <span class="k">fi</span>

  <span class="k">else</span>

    <span class="c1"># POST: mongo variable already set</span>

    <span class="c1"># Check if file is correct</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$mongo</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="s2">&quot;Use mongo: </span><span class="nv">$mongo</span><span class="s2">\n&quot;</span>

      <span class="nv">MONGO_CLIENT</span><span class="o">=</span><span class="nv">$psq</span>

    <span class="k">else</span>

      error_generate <span class="s2">&quot;</span><span class="nv">$mongo</span><span class="s2"> program invalid.&quot;</span>

      <span class="k">return</span> 1

    <span class="k">fi</span>

  <span class="k">fi</span>

  <span class="nb">export</span> MONGO_CLIENT

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-check-vars">
<span id="commons-mongo-check-vars"></span><h3>commons_mongo_check_vars<a class="headerlink" href="#commons-mongo-check-vars" title="Permalink to this headline">¶</a></h3>
<p>Check if are present mandatary mongo environment variables:</p>
<ul class="simple">
<li>MONGO_USER</li>
<li>MONGO_PWD</li>
<li>MONGO_DB</li>
<li>MONGO_DIR</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: all mandatory variables are present.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error (program is interrupter with exit 1 command)</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock172'))">(Show/Hide)</a><br /><div id="hiddencodeblock172" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_check_vars <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">commons_msg</span><span class="o">=</span><span class="s1">&#39;variable on configuration file, through arguments or on current profile.&#39;</span>

  check_var <span class="s2">&quot;MONGO_USER&quot;</span> <span class="o">||</span> error_handled <span class="s2">&quot;You must define MONGO_USER </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MONGO_PWD&quot;</span>  <span class="o">||</span> error_handled <span class="s2">&quot;You must define MONGO_PWD </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MONGO_DB&quot;</span>   <span class="o">||</span> error_handled <span class="s2">&quot;You must define MONGO_DB </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>
  check_var <span class="s2">&quot;MONGO_DIR&quot;</span>  <span class="o">||</span> error_handled <span class="s2">&quot;You must define MONGO_DIR </span><span class="nv">$commons_msg</span><span class="s2">&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-check-connection">
<span id="commons-mongo-check-connection"></span><h3>commons_mongo_check_connection<a class="headerlink" href="#commons-mongo-check-connection" title="Permalink to this headline">¶</a></h3>
<p>Check connection to database.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: when connection is ok.</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock173'))">(Show/Hide)</a><br /><div id="hiddencodeblock173" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_check_connection <span class="o">()</span> <span class="o">{</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MONGO_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2">&quot;</span> !<span class="o">=</span> *--quiet* <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;--quiet&quot;</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mongo_check_connection) Try connection with </span><span class="nv">$MONGO_CLIENT</span><span class="s2"> </span><span class="nv">$mongo_auth</span><span class="s2"> </span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$opts</span><span class="s2">.\n&quot;</span>

  <span class="nb">eval</span> <span class="nv">$MONGO_CLIENT</span> <span class="nv">$mongo_auth</span> <span class="nv">$MONGO_EXTRA_OPTIONS</span> <span class="nv">$opts</span> <span class="nv">$2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">exit</span>
<span class="s">EOF</span>

  <span class="nv">errorCode</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">errorCode</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="nb">unset</span> errorCode

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;mongo was connected successfully&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-shell">
<span id="commons-mongo-shell"></span><h3>commons_mongo_shell<a class="headerlink" href="#commons-mongo-shell" title="Permalink to this headline">¶</a></h3>
<p>Enter on command line shell of MongoDB server.</p>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock174'))">(Show/Hide)</a><br /><div id="hiddencodeblock174" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_shell <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">errorCode</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MONGO_CLIENT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$mongo_auth</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mongo_shell) Try connection with </span><span class="nv">$opts</span><span class="s2"> </span><span class="nv">$MONGO_EXTRA_OPTIONS</span><span class="s2"> </span><span class="nv">$mongo_auth</span><span class="s2">.\n&quot;</span>

  <span class="nb">eval</span> <span class="nv">$MONGO_CLIENT</span> <span class="nv">$opts</span> <span class="nv">$MONGO_EXTRA_OPTIONS</span> <span class="nv">$mongo_auth</span>

  <span class="nv">errorCode</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">errorCode</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="nb">unset</span> errorCode

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-compile-file">
<span id="commons-mongo-compile-file"></span><h3>commons_mongo_compile_file<a class="headerlink" href="#commons-mongo-compile-file" title="Permalink to this headline">¶</a></h3>
<p>Compile a file to current mongodb database.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (file) File to compile.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to write on logfile before and after compilation.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (use_initrc) Optional argument to force use of mongo_file_initrc (default)
or mongo_file command if equal to 0.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock175'))">(Show/Hide)</a><br /><div id="hiddencodeblock175" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_compile_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local</span> <span class="nv">use_initrc</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="k">:-</span><span class="nv">1</span><span class="si">}</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$f</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    _logfile_write <span class="s2">&quot;(mongo) File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span> <span class="o">||</span> <span class="k">return</span> 1
    <span class="k">return</span> 1
  <span class="k">fi</span>

  _logfile_write <span class="s2">&quot;(mongo) Start compilation (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> <span class="s2">&quot;(mongo) Start compilation (file </span><span class="nv">$f_base</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span>

  <span class="nv">MONGO_OUTPUT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$use_initrc</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    mongo_file <span class="s2">&quot;MONGO_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    mongo_file_initrc <span class="s2">&quot;MONGO_OUTPUT&quot;</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MONGO_INITRC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
  <span class="nb">local</span> <span class="nv">ans</span><span class="o">=</span><span class="nv">$?</span>

  _logfile_write <span class="s2">&quot;\n</span><span class="nv">$MONGO_OUTPUT</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  _logfile_write <span class="s2">&quot;(mongo) End compilation (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">echo</span> -en <span class="s2">&quot;(mongo) End compilation (file </span><span class="nv">$f_base</span><span class="s2">, result =&gt; </span><span class="nv">$ans</span><span class="s2">): </span><span class="nv">$msg</span><span class="s2">\n&quot;</span>

  <span class="k">return</span> <span class="nv">$ans</span>
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-get-indexes-list">
<span id="commons-mongo-get-indexes-list"></span><h3>commons_mongo_get_indexes_list<a class="headerlink" href="#commons-mongo-get-indexes-list" title="Permalink to this headline">¶</a></h3>
<p>Retrieve list of all indexes of current mongodb database and some statistics.
This method store result on associative array with name <em>mongo_indexes</em> that
contains these columns:</p>
<ul class="simple">
<li>collection: Name of the collection.</li>
<li>key: Name of the index</li>
<li>keys: list of keys of the index separated by comma</li>
<li>n_keys: number of keys of the index</li>
<li>keys_complete: list of the index keys on JSON format</li>
<li>index size: current index size</li>
<li>index options: index options (for example unique, expireAfterSec, etc.)</li>
</ul>
<p>For identify the size of the array it is needed divide number of records
between number of columns (in this case 7) and then iterate for number of
elements.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  commons_mongo_get_indexes_list <span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span>

  <span class="nb">local</span> <span class="nv">n_indexes</span><span class="o">=</span><span class="si">${#</span><span class="nv">mongo_indexes</span><span class="p">[@]</span><span class="si">}</span>
  <span class="nb">local</span> <span class="nv">real_n_indexes</span><span class="o">=</span><span class="k">$((</span>n_indexes/7<span class="k">))</span>

  <span class="c1"># Retrieve data for every index</span>
  <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">real_n_indexes</span><span class="si">}</span><span class="p">;</span> i++<span class="o">)</span> <span class="p">;</span> <span class="k">do</span>
      <span class="nb">local</span> <span class="nv">kcoll</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 0]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">kname</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 1]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">n_keys</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 3]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 4]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">idxsize</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 5]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">idxopts</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 6]</span><span class="si">}</span>
  <span class="k">done</span>
</pre></div>
</div>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (single_collection) If present permit to retrieve list
of indexes of a particular collection. If not present or
equal to empty string than all indexes of database are returned.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (filter_keyname) Optional argument that permit to filter
indexes with a particula key name.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (ignore_id_) Optional argument that permit to filter
special index _id from list. Possible values are 0 (default)
and 1 (ignore index with key name <em>id</em>).</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock176'))">(Show/Hide)</a><br /><div id="hiddencodeblock176" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_get_indexes_list <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">single_collection</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">filter_keyname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">ignore_id_</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span>
  <span class="nb">local</span> <span class="nv">pos</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_get_indexes_list) args: collection &#39;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&#39;, filter = &#39;</span><span class="si">${</span><span class="nv">filter_keyname</span><span class="si">}</span><span class="s2">&#39;, ignore_id_=&#39;</span><span class="si">${</span><span class="nv">ignore_id_</span><span class="si">}</span><span class="s2">&#39;\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">db.getCollectionNames().forEach(function(n){</span>
<span class="s2">  print( JSON.stringify(db[n].getIndexSpecs()));</span>
<span class="s2">})&quot;</span>

  <span class="k">else</span>

    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;JSON.stringify(db[&#39;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&#39;].getIndexSpecs())&quot;</span>

  <span class="k">fi</span>


  <span class="c1"># Retrieve stats data for index</span>
  commons_mongo_stats <span class="s2">&quot;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;index&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  mongo_cmd_4var <span class="s2">&quot;_mongo_ans&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="c1"># Create associative array for every entry</span>
  <span class="c1"># with column:</span>
  <span class="c1"># - collection</span>
  <span class="c1"># - key name</span>
  <span class="c1"># - keys</span>
  <span class="c1"># - n_keys</span>
  <span class="c1"># - keys_complete</span>
  <span class="c1"># - index size</span>
  <span class="c1"># - index options</span>

  <span class="nb">unset</span> mongo_indexes
  <span class="nb">declare</span> -g -A mongo_indexes

  <span class="c1"># Reset array and declare it</span>
  <span class="nv">mongo_indexes</span><span class="o">=()</span>

  <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
  <span class="k">for</span> row in <span class="nv">$_mongo_ans</span> <span class="p">;</span> <span class="k">do</span>

    <span class="nb">local</span> <span class="nv">n_indexes</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq <span class="s1">&#39;length&#39;</span><span class="k">)</span>
    <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>0

    <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">n_indexes</span><span class="si">}</span><span class="p">;</span>i++<span class="o">))</span> <span class="p">;</span> <span class="k">do</span>

      <span class="nb">local</span> <span class="nv">kname</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .<span class="o">[</span><span class="nv">$i</span><span class="o">]</span>.name <span class="k">)</span>

      <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">filter_keyname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="si">${</span><span class="nv">filter_keyname</span><span class="si">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="k">continue</span>
      <span class="k">fi</span>

      <span class="k">if</span> <span class="o">[[</span> <span class="si">${</span><span class="nv">ignore_id_</span><span class="si">}</span> -eq <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;_id_&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="k">continue</span>
      <span class="k">fi</span>

      <span class="nb">local</span> <span class="nv">kcoll</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .<span class="o">[</span><span class="nv">$i</span><span class="o">]</span>.ns <span class="p">|</span> cut -d<span class="s1">&#39;.&#39;</span> -f 2<span class="k">)</span>
      <span class="nb">local</span> <span class="nv">n_keys</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq <span class="s2">&quot;.[</span><span class="nv">$i</span><span class="s2">].key | keys | length&quot;</span><span class="k">)</span>
      <span class="nb">local</span> <span class="nv">keys</span><span class="o">=(</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.[</span><span class="nv">$i</span><span class="s2">].key | keys | .[]&quot;</span><span class="k">)</span><span class="o">)</span>
      <span class="nv">keys</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">keys</span><span class="p">[@]</span><span class="si">}</span> <span class="p">|</span> tr <span class="s2">&quot; &quot;</span> <span class="se">\,</span><span class="k">)</span>
      <span class="nb">local</span> <span class="nv">index_size</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="si">${</span><span class="nv">kcoll</span><span class="si">}</span><span class="p">, </span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>

      <span class="nb">local</span> <span class="nv">keys_complete</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -M -c <span class="s2">&quot;.[</span><span class="nv">$i</span><span class="s2">].key&quot;</span><span class="k">)</span>

      <span class="nb">local</span> <span class="nv">key_options</span><span class="o">=(</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.[</span><span class="nv">$i</span><span class="s2">] | keys | .[]&quot;</span><span class="k">)</span><span class="o">)</span>
      <span class="nb">local</span> <span class="nv">opts_json</span><span class="o">=</span><span class="s2">&quot;{&quot;</span>

      <span class="nb">local</span> <span class="nv">opt</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
      <span class="k">for</span> opt in <span class="si">${</span><span class="nv">key_options</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>

        <span class="nb">local</span> <span class="nv">opt_val</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">case</span> <span class="nv">$opt</span> in
          v<span class="p">|</span>key<span class="p">|</span>ns<span class="p">|</span>name<span class="o">)</span>
            <span class="p">;;</span>
          *<span class="o">)</span>
            <span class="nv">opt_val</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -M <span class="s2">&quot;.[</span><span class="nv">$i</span><span class="s2">].</span><span class="nv">$opt</span><span class="s2">&quot;</span><span class="k">)</span>

            <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">opts_json</span><span class="si">}</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
              <span class="nv">opts_json</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">opts_json</span><span class="si">}</span><span class="s2"> \&quot;</span><span class="si">${</span><span class="nv">opt</span><span class="si">}</span><span class="s2">\&quot; : </span><span class="si">${</span><span class="nv">opt_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span>
              <span class="nv">opts_json</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">opts_json</span><span class="si">}</span><span class="s2">, \&quot;</span><span class="si">${</span><span class="nv">opt</span><span class="si">}</span><span class="s2">\&quot; : </span><span class="si">${</span><span class="nv">opt_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">fi</span>
            <span class="p">;;</span>
        <span class="k">esac</span>

      <span class="k">done</span>

      <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">opts_json</span><span class="si">}</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">opts_json</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
      <span class="k">else</span>
        <span class="nv">opts_json</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">opts_json</span><span class="si">}</span><span class="s2"> }&quot;</span>
      <span class="k">fi</span>

      <span class="c1"># echo -e $(printf &#39;%q&#39; $opts_json) | jq</span>
      <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
        <span class="s2">&quot;(commons_mongo_get_indexes_list) kname = </span><span class="nv">$kname</span><span class="s2">, kcoll =</span><span class="nv">$kcoll</span><span class="s2">, n_keys=</span><span class="nv">$n_keys</span><span class="s2">, keys=</span><span class="nv">$keys_complete</span><span class="s2">.\n&quot;</span>

      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 0<span class="o">]=</span><span class="si">${</span><span class="nv">kcoll</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 1<span class="o">]=</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 2<span class="o">]=</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 3<span class="o">]=</span><span class="si">${</span><span class="nv">n_keys</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 4<span class="o">]=</span><span class="si">${</span><span class="nv">keys_complete</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 5<span class="o">]=</span><span class="si">${</span><span class="nv">index_size</span><span class="k">:-</span><span class="s2">&quot;N.A&quot;</span><span class="si">}</span>
      mongo_indexes<span class="o">[</span><span class="nv">$pos</span>, 6<span class="o">]=</span><span class="si">${</span><span class="nv">opts_json</span><span class="si">}</span>

      <span class="nb">let</span> pos++

    <span class="k">done</span>

  <span class="k">done</span>
  <span class="nb">unset</span> IFS

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_get_indexes_list) Found </span><span class="si">${#</span><span class="nv">mongo_indexes</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$pos</span><span class="s2">) indexes.\n&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-stats">
<span id="commons-mongo-stats"></span><h3>commons_mongo_stats<a class="headerlink" href="#commons-mongo-stats" title="Permalink to this headline">¶</a></h3>
<p>Retrieve statistics data of collections, indexes or custom stats.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (single_collection) If present permit to retrieve data
of a particular collection. If not present or
equal to empty string than all collections of database
are used for retrieve data.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (target) Identify type of data returned. Possible values
are <em>collection</em>, <em>index</em>, <em>custom</em>.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (custom_content) Optional argument that contains <em>jq</em>
parse string for retrieve a custom data from json stats
of collection. It is used when target contains <em>custom</em>.</li>
</ul>
<p>Result data are store on <code class="docutils literal"><span class="pre">mongo_stats</span></code> array.</p>
<p>If target is equal to <em>collection</em> then is returned an associative
array with this columns:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">collection</span></code>: Name of the collection</li>
<li><code class="docutils literal"><span class="pre">storageSize</span></code>: Storage size of the collection</li>
<li><code class="docutils literal"><span class="pre">sharded</span></code>: Identify if collection is sharded (1) or not (0)</li>
<li><code class="docutils literal"><span class="pre">primary</span></code>: If not sharded contains name of the primary node.</li>
<li><code class="docutils literal"><span class="pre">count</span></code>: Number of documents of the collections.</li>
<li><code class="docutils literal"><span class="pre">nindexes</span></code>: Number of indexes of the collections.</li>
<li><code class="docutils literal"><span class="pre">totalIndexSize</span></code>: total size of all indexes of the collection.</li>
<li><code class="docutils literal"><span class="pre">capped</span></code>: If collection is capped (1) or not (0)</li>
<li><code class="docutils literal"><span class="pre">avgObjSize</span></code>: contains average document size</li>
<li><code class="docutils literal"><span class="pre">size</span></code>: size of the collection</li>
<li><code class="docutils literal"><span class="pre">sharded</span> <span class="pre">nodes</span></code>: If sharded list of sharded nodes.</li>
</ul>
<p>For identify the size of the array it is needed divide number of records
between number of columns (in this case 11) and then iterate for number of
elements.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  commons_mongo_stats <span class="s2">&quot;&quot;</span> <span class="s2">&quot;collection&quot;</span>

  <span class="nb">local</span> <span class="nv">n_colls</span><span class="o">=</span><span class="si">${#</span><span class="nv">mongo_stats</span><span class="p">[@]</span><span class="si">}</span>
  <span class="nb">local</span> <span class="nv">real_n_colls</span><span class="o">=</span><span class="k">$((</span>n_stats/7<span class="k">))</span>

  <span class="c1"># Retrieve data for every collection</span>
  <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">real_n_colls</span><span class="si">}</span><span class="p">;</span> i++<span class="o">)</span> <span class="p">;</span> <span class="k">do</span>
      <span class="nb">local</span> <span class="nv">coll</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 0]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">storsize</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 1]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">sharded</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 2]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">primary</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 3]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">count</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 4]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">n_idx</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 5]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">totIdx</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 6]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">capped</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 7]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">avgObjSize</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 8]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">size</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 9]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">shardedNodes</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 10]</span><span class="si">}</span>
  <span class="k">done</span>
</pre></div>
</div>
<p>If target is equal to <em>index</em> then is returned an associative
array with this columns:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">index</span> <span class="pre">size</span></code>: Size of the index.</li>
</ul>
<p>and where key of the array is composed by <em>collection name</em> and <em>index key
name</em>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  commons_mongo_stats <span class="s2">&quot;&quot;</span> <span class="s2">&quot;index&quot;</span>

  <span class="c1"># Found index size of key &quot;index1&quot; and collection &quot;c1&quot;</span>
  cal <span class="nv">indexSize</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">, </span><span class="s2">&quot;index1&quot;</span><span class="p">]</span><span class="si">}</span>
</pre></div>
</div>
<p>If target is equal to <em>custom</em> then is returned an associative
array with this columns:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">collection</span></code>: Name of the collection</li>
<li><code class="docutils literal"><span class="pre">json</span></code>: Custom json content returned by input js string.</li>
</ul>
<p>For identify the size of the array it is needed divide number of records
between number of columns (in this case 2) and then iterate for number of
elements.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  commons_mongo_stats <span class="s2">&quot;&quot;</span> <span class="s2">&quot;custom&quot;</span> <span class="s2">&quot;.wiredTiger.cache&quot;</span>

  <span class="nb">local</span> <span class="nv">n_colls</span><span class="o">=</span><span class="si">${#</span><span class="nv">mongo_stats</span><span class="p">[@]</span><span class="si">}</span>
  <span class="nb">local</span> <span class="nv">real_n_colls</span><span class="o">=</span><span class="k">$((</span>n_stats/2<span class="k">))</span>

  <span class="c1"># Retrieve data for every collection</span>
  <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">real_n_colls</span><span class="si">}</span><span class="p">;</span> i++<span class="o">)</span> <span class="p">;</span> <span class="k">do</span>
      <span class="nb">local</span> <span class="nv">coll</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 0]</span><span class="si">}</span>
      <span class="nb">local</span> <span class="nv">custom_json</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_stats</span><span class="p">[</span><span class="nv">$i</span><span class="p">, 1]</span><span class="si">}</span>
  <span class="k">done</span>
</pre></div>
</div>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock177'))">(Show/Hide)</a><br /><div id="hiddencodeblock177" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_stats <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">scale</span><span class="o">=</span>1024
  <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">pos</span><span class="o">=</span>0
  <span class="nb">local</span> <span class="nv">i</span><span class="o">=</span>0
  <span class="c1"># Contains collection name.</span>
  <span class="nb">local</span> <span class="nv">single_collection</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="c1"># target values are: collection | index | custom</span>
  <span class="nb">local</span> <span class="nv">target</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="c1"># Custom content permit to customize filter for</span>
  <span class="c1"># jq parser and return JSON to process.</span>
  <span class="nb">local</span> <span class="nv">custom_content</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_mongo_stats) args: </span><span class="nv">$@</span><span class="s2">.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">db.getCollectionNames().forEach(function(n) {</span>
<span class="s2">  print( JSON.stringify(db[n].stats({scale: </span><span class="si">${</span><span class="nv">scale</span><span class="si">}</span><span class="s2">})) );</span>
<span class="s2">})&quot;</span>
  <span class="k">else</span>
    <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;JSON.stringify(db[&#39;</span><span class="si">${</span><span class="nv">single_collection</span><span class="si">}</span><span class="s2">&#39;].stats({scale: </span><span class="si">${</span><span class="nv">scale</span><span class="si">}</span><span class="s2">}))&quot;</span>
  <span class="k">fi</span>

  mongo_cmd_4var <span class="s2">&quot;_mongo_stats&quot;</span> <span class="s2">&quot;</span><span class="nv">$cmd</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="nb">unset</span> mongo_stats
  <span class="nb">declare</span> -g -A mongo_stats
  <span class="nv">mongo_stats</span><span class="o">=()</span>

  <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
  <span class="k">for</span> row in <span class="nv">$_mongo_stats</span> <span class="p">;</span> <span class="k">do</span>

    <span class="nb">local</span> <span class="nv">row_coll</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .ns <span class="p">|</span> cut -d<span class="s1">&#39;.&#39;</span> -f 2<span class="k">)</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">target</span><span class="si">}</span><span class="s2">&quot;</span> in
      collection<span class="o">)</span>

        <span class="c1"># Create associative array with columns (number index):</span>
        <span class="c1"># - collection</span>
        <span class="c1"># - storageSize</span>
        <span class="c1"># - sharded</span>
        <span class="c1"># - primary</span>
        <span class="c1"># - count</span>
        <span class="c1"># - nindexes</span>
        <span class="c1"># - totalIndexSize</span>
        <span class="c1"># - capped</span>
        <span class="c1"># - average object size</span>
        <span class="c1"># - size</span>
        <span class="c1"># - sharded nodes</span>
        <span class="nb">local</span> <span class="nv">storageSize</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">sharded</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">primary</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">count</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">nindexes</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">totalIndexSize</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">capped</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">avgObjSize</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">size</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">shardedNodes</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="nv">storageSize</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .storageSize<span class="k">)</span>
        <span class="nv">sharded</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .sharded<span class="k">)</span>

        <span class="nv">count</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .count<span class="k">)</span>
        <span class="nv">nindexes</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .nindexes<span class="k">)</span>
        <span class="nv">totalIndexSize</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .totalIndexSize<span class="k">)</span>
        <span class="nv">capped</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .capped<span class="k">)</span>
        <span class="nv">avgObjSize</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .avgObjSize<span class="k">)</span>
        <span class="nv">size</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .size<span class="k">)</span>

        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 0<span class="o">]=</span><span class="si">${</span><span class="nv">row_coll</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 1<span class="o">]=</span><span class="si">${</span><span class="nv">storageSize</span><span class="si">}</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">sharded</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
          mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 2<span class="o">]=</span>0
          <span class="nv">primary</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M .primary<span class="k">)</span>
          <span class="nv">shardedNodes</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
        <span class="k">else</span>
          mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 2<span class="o">]=</span>1
          <span class="nv">primary</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
          <span class="nv">shardedNodes</span><span class="o">=(</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.shards | keys | .[]&quot;</span><span class="k">)</span><span class="o">)</span>
          <span class="nv">shardedNodes</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">shardedNodes</span><span class="p">[@]</span><span class="si">}</span> <span class="p">|</span> tr <span class="s2">&quot; &quot;</span> <span class="se">\,</span><span class="k">)</span>
        <span class="k">fi</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 3<span class="o">]=</span><span class="si">${</span><span class="nv">primary</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 4<span class="o">]=</span><span class="si">${</span><span class="nv">count</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 5<span class="o">]=</span><span class="si">${</span><span class="nv">nindexes</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 6<span class="o">]=</span><span class="si">${</span><span class="nv">totalIndexSize</span><span class="si">}</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">capped</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
          mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 7<span class="o">]=</span>0
        <span class="k">else</span>
          mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 7<span class="o">]=</span>1
        <span class="k">fi</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 8<span class="o">]=</span><span class="si">${</span><span class="nv">avgObjSize</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 9<span class="o">]=</span><span class="si">${</span><span class="nv">size</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 10<span class="o">]=</span><span class="si">${</span><span class="nv">shardedNodes</span><span class="si">}</span>
        <span class="p">;;</span>

      index<span class="o">)</span>

        <span class="c1"># Create associative array with columns (key is collection, index name):</span>
        <span class="c1"># - index size</span>
        <span class="nb">local</span> <span class="nv">indexSize</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local</span> <span class="nv">nkeys</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.indexSizes | length&quot;</span><span class="k">)</span>

        <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">nkeys</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

          <span class="nb">local</span> <span class="nv">keys</span><span class="o">=(</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.indexSizes | keys | .[]&quot;</span><span class="k">)</span><span class="o">)</span>

          <span class="k">for</span> key in <span class="si">${</span><span class="nv">keys</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>

            <span class="nv">indexSizes</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -r -M <span class="s2">&quot;.indexSizes.</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
            mongo_stats<span class="o">[</span><span class="si">${</span><span class="nv">row_coll</span><span class="si">}</span>, <span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">indexSizes</span><span class="si">}</span>

          <span class="k">done</span> <span class="c1"># end for key</span>

        <span class="k">fi</span>

        <span class="p">;;</span>

      custom<span class="o">)</span>
        <span class="c1"># Create associative array with columns for collection (number index):</span>
        <span class="c1"># - collection</span>
        <span class="c1"># - custom json</span>
        <span class="nb">local</span> <span class="nv">custom_json</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$row</span> <span class="p">|</span> jq -M <span class="s2">&quot;</span><span class="si">${</span><span class="nv">custom_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 0<span class="o">]=</span><span class="si">${</span><span class="nv">row_coll</span><span class="si">}</span>
        mongo_stats<span class="o">[</span><span class="nv">$pos</span>, 1<span class="o">]=</span><span class="si">${</span><span class="nv">custom_json</span><span class="si">}</span>

        <span class="p">;;</span>
    <span class="k">esac</span>

    <span class="nb">let</span> pos++

  <span class="k">done</span> <span class="c1"># end for</span>
  <span class="nb">unset</span> IFS

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_stats) Found </span><span class="si">${#</span><span class="nv">mongo_stats</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> (</span><span class="nv">$pos</span><span class="s2">) data.\n&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-create-index-file">
<span id="commons-mongo-create-index-file"></span><h3>commons_mongo_create_index_file<a class="headerlink" href="#commons-mongo-create-index-file" title="Permalink to this headline">¶</a></h3>
<p>Create index file for compilation under <code class="docutils literal"><span class="pre">$MONGO_DIR</span></code>/indexes directory.
This function create only the file without execute it on database.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (coll) name of the collection where create index.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (name) Name of the index to create.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (keys) list of keys as json content to use for create index.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (opts) list of key options on json format to use on creation script.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  <span class="c1"># Create index for collection c1 for fiedl f1 with option unique.</span>
  commons_mongo_create_file <span class="s2">&quot;c1&quot;</span> <span class="s2">&quot;indexf1&quot;</span> <span class="s2">&quot;{f1:-1}&quot;</span> <span class="s2">&quot;{\&quot;unique\&quot;:true}&quot;</span>
</pre></div>
</div>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock178'))">(Show/Hide)</a><br /><div id="hiddencodeblock178" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_create_index_file <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">coll</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>

  <span class="nb">local</span> <span class="nv">indexesdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MONGO_DIR</span><span class="si">}</span><span class="s2">/indexes&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.js&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_create_index_file): coll=&#39;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&#39; name=&#39;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&#39; keys=&#39;</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">&#39; opts=&#39;</span><span class="si">${</span><span class="nv">opts</span><span class="si">}</span><span class="s2">, f=</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&#39;.\n&quot;</span>


  <span class="c1"># Check if exists indexes or create it</span>
  <span class="k">if</span> <span class="o">[[</span> ! -d <span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    mkdir -p <span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on create directory </span><span class="si">${</span><span class="nv">indexesdir</span><span class="si">}</span><span class="s2">.&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># TODO: check if key is already present on database</span>
  <span class="c1">#       also with a different name.</span>
  <span class="c1"># TODO: add header to index file as comment (through MONGO_HEADER variable)</span>

  <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">opts</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;{}&quot;</span>

  <span class="nv">opts</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -e <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="nv">$opts</span><span class="k">)</span> <span class="p">|</span> jq --arg name <span class="nv">$name</span> <span class="s1">&#39;. + { name: $name}&#39;</span><span class="k">)</span>

  <span class="c1">#echo -e &#39;{ }&#39; | jq --arg name prova &#39;. + { name: $name}&#39;</span>
  <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">db.</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">.createIndex(</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2"> ,</span>
<span class="si">${</span><span class="nv">opts</span><span class="si">}</span><span class="s2"> );</span>

<span class="s2">&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_create_index_file) content =\n</span><span class="nv">$content</span><span class="s2">\n&quot;</span>

  <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$content</span><span class="s2">&quot;</span> &gt; <span class="nv">$f</span> <span class="o">||</span> error_generate <span class="s2">&quot;Error on write file </span><span class="nv">$f</span><span class="s2">.&quot;</span>

  _logfile_write <span class="s2">&quot;(mongo) Created index </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> for collection </span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2"> (file </span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">||</span> <span class="se">\</span>
    <span class="k">return</span> 1

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-download-index">
<span id="commons-mongo-download-index"></span><h3>commons_mongo_download_index<a class="headerlink" href="#commons-mongo-download-index" title="Permalink to this headline">¶</a></h3>
<p>Download and index configuration and create a creation script under `$MONGO_DIR/indexes directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (coll) name of the collection where download index data.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (kname) Name of the index to download.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (arr_pos) Optional parameter that contains position of the
index to download when there is already an valorized
array mongo_indexes previously initialized.
If not present function download indipendently
index data through commons_mongo_get_indexes_list
function.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock179'))">(Show/Hide)</a><br /><div id="hiddencodeblock179" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_download_index <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">coll</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">kname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="c1"># optional: set with position of mongo_indexes array if already</span>
  <span class="c1">#           initialized.</span>
  <span class="nb">local</span> <span class="nv">arr_pos</span><span class="o">=</span><span class="nv">$3</span>
  <span class="nb">local</span> <span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_download_index): coll=&#39;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&#39; kname=&#39;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&#39; pos=</span><span class="si">${</span><span class="nv">arr_pos</span><span class="si">}</span><span class="s2">.\n&quot;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">arr_pos</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    commons_mongo_get_indexes_list <span class="s2">&quot;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
      error_generate <span class="s2">&quot;Error retrieve index data&quot;</span>

    <span class="o">[</span> <span class="si">${#</span><span class="nv">mongo_indexes</span><span class="p">[@]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
      error_generate <span class="s2">&quot;No index </span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2"> for collection </span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2"> found.&quot;</span>

    <span class="nv">arr_pos</span><span class="o">=</span>0

  <span class="k">fi</span>

  <span class="nv">keys</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$arr_pos</span><span class="p">, 4]</span><span class="si">}</span>
  <span class="nv">opts</span><span class="o">=</span><span class="si">${</span><span class="nv">mongo_indexes</span><span class="p">[</span><span class="nv">$arr_pos</span><span class="p">, 6]</span><span class="si">}</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> -en <span class="s2">&quot;(commons_mongo_download_index): Found keys=&#39;</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">&#39;, opts=&#39;</span><span class="si">${</span><span class="nv">opts</span><span class="si">}</span><span class="s2">&#39;.\n&quot;</span>

  commons_mongo_create_index_file <span class="s2">&quot;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">keys</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">opts</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_generate <span class="s2">&quot;Error on create index file.&quot;</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-download-all-indexes">
<span id="commons-mongo-download-all-indexes"></span><h3>commons_mongo_download_all_indexes<a class="headerlink" href="#commons-mongo-download-all-indexes" title="Permalink to this headline">¶</a></h3>
<p>Download all indexes to MONGO_DIR/indexes directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (collection) download all indexes of input collection.
Empty string means all indexes.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (include_id_) Optional parameter that could be
set to 0 (default value) when special index _id
are ignored from download or set 1 when on download
are created also files related with special index _id.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock180'))">(Show/Hide)</a><br /><div id="hiddencodeblock180" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-drop-index">
<span id="commons-mongo-drop-index"></span><h3>commons_mongo_drop_index<a class="headerlink" href="#commons-mongo-drop-index" title="Permalink to this headline">¶</a></h3>
<p>Drop a index from database if exists.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (coll) name of the collection where drop index.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (kname) Name of the index to drop. If not present
then all indexes of the collection are dropped.
Excluded special index that can be removed
only for capped collection.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock181'))">(Show/Hide)</a><br /><div id="hiddencodeblock181" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-compile-idx">
<span id="commons-mongo-compile-idx"></span><h3>commons_mongo_compile_idx<a class="headerlink" href="#commons-mongo-compile-idx" title="Permalink to this headline">¶</a></h3>
<p>Compile file related with index of a collection..</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (f) path of the file to compile</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg) message to insert on logging file relative to input file</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (force) if index is present and force is equal to 1, then
index is dropped and added again. NOT IMPLEMENTED.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock182'))">(Show/Hide)</a><br /><div id="hiddencodeblock182" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_compile_idx <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
  <span class="c1"># TODO: force option 3 support</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">f_base</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">idx_dir</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="nb">local</span> <span class="nv">idx_str</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">f_base</span><span class="p">/.js/</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">coll</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span> <span class="p">|</span> cut -d<span class="s1">&#39;.&#39;</span> -f1<span class="k">)</span>
  <span class="nb">local</span> <span class="nv">kname</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">idx_str</span><span class="si">}</span> <span class="p">|</span> cut -d<span class="s1">&#39;.&#39;</span> -f2<span class="k">)</span>

  <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
    <span class="s2">&quot;(commons_mongo_compile_idx): coll=&#39;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&#39; kname=&#39;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&#39; f=</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">.\n&quot;</span>

  <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> error_generate <span class="s2">&quot;(commons_mongo_compile_idx) Invalid argument&quot;</span>

  <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nb">local</span> <span class="nv">log</span><span class="o">=</span><span class="s2">&quot;File </span><span class="nv">$f</span><span class="s2"> not found.&quot;</span>
    _logfile_write <span class="s2">&quot;(mongo) </span><span class="si">${</span><span class="nv">log</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

    out_handler_print <span class="s2">&quot;</span><span class="si">${</span><span class="nv">log</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
      <span class="s2">&quot;(commons_mongo_compile_idx) File </span><span class="nv">$f</span><span class="s2"> not found.\n&quot;</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>

  <span class="c1"># Check if index is already present.</span>
  commons_mongo_get_indexes_list <span class="s2">&quot;</span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    error_handled <span class="s2">&quot;Error on check if index </span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2"> already exists.&quot;</span>

  <span class="nb">local</span> <span class="nv">n_indexes</span><span class="o">=</span><span class="si">${#</span><span class="nv">mongo_indexes</span><span class="p">[@]</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$n_indexes</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

    <span class="nb">local</span> <span class="nv">log</span><span class="o">=</span><span class="s2">&quot;Index </span><span class="si">${</span><span class="nv">coll</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">kname</span><span class="si">}</span><span class="s2"> is already present. Nothing to do.&quot;</span>
    out_handler_print <span class="s2">&quot;</span><span class="si">${</span><span class="nv">log</span><span class="si">}</span><span class="s2">&quot;</span>

    _logfile_write <span class="s2">&quot;(mongo) </span><span class="si">${</span><span class="nv">log</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">else</span>

    commons_mongo_compile_file <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">fi</span>

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-compile-all-from-dir">
<span id="commons-mongo-compile-all-from-dir"></span><h3>commons_mongo_compile_all_from_dir<a class="headerlink" href="#commons-mongo-compile-all-from-dir" title="Permalink to this headline">¶</a></h3>
<p>Compile all files from input directory with .js extension.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (directory) Directory where there are files to compile.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (msg_head) Title message insert on logfile before compile files.</li>
<li><code class="docutils literal"><span class="pre">$3</span></code>: (msg) message insert on logfile before compile files.</li>
<li><code class="docutils literal"><span class="pre">$4</span></code>: (type) Identify type of directory: idx or empty.
Optional.</li>
<li><code class="docutils literal"><span class="pre">$5</span></code>: (closure) custom parameter with a value relative to type.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock183'))">(Show/Hide)</a><br /><div id="hiddencodeblock183" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_compile_all_from_dir <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">msg_head</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">dtype</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">closure</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$5</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fb</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">ex_f</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="nb">local</span> <span class="nv">fk_is_present</span><span class="o">=</span>1
  <span class="nb">local</span> <span class="nv">exc</span><span class="o">=</span>0

  _logfile_write <span class="s2">&quot;(mongo) Start compilation </span><span class="nv">$msg_head</span><span class="s2">: </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">for</span> i in <span class="nv">$directory</span>/*.js <span class="p">;</span> <span class="k">do</span>

    <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="p">;</span> <span class="k">then</span>
      <span class="k">continue</span>
    <span class="k">fi</span>

    <span class="nv">fk_is_present</span><span class="o">=</span>1
    <span class="nv">exc</span><span class="o">=</span>0

    <span class="nv">fb</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$i</span><span class="sb">`</span>
    <span class="nv">f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fb</span><span class="p">/.js/</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Check if file is excluded</span>
    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;</span><span class="nv">$MONGO_COMPILE_FILES_EXCLUDED</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

      <span class="k">for</span> e in <span class="nv">$MONGO_COMPILE_FILES_EXCLUDED</span> <span class="p">;</span> <span class="k">do</span>

        <span class="nv">ex_f</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$e</span><span class="sb">`</span>
        <span class="nv">ex_f</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ex_f</span><span class="p">/.js/</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ex_f</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
          <span class="nv">exc</span><span class="o">=</span>1

          _logfile_write <span class="s2">&quot;(mongo) Exclude file </span><span class="nv">$fb</span><span class="s2"> for user request.&quot;</span>

          <span class="nb">break</span>
        <span class="k">fi</span>

      <span class="k">done</span> <span class="c1"># end for exclueded</span>

    <span class="k">fi</span>

    <span class="c1"># If file is excluded go to the next</span>
    <span class="o">[</span> <span class="nv">$exc</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>

    <span class="o">[[</span> <span class="nv">$DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nv">$DEBUG</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -en <span class="se">\</span>
      <span class="s2">&quot;(commons_mongo_compile_all_from_dir: compile file [</span><span class="nv">$i</span><span class="s2">].\n&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> x<span class="s2">&quot;</span><span class="nv">$dtype</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;idx&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>

      commons_mongo_compile_idx <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">closure</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">else</span>

      commons_mongo_compile_file <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;1&quot;</span>

    <span class="k">fi</span>

    <span class="c1"># POST: on error go to next file</span>

  <span class="k">done</span> <span class="c1"># end for</span>

  _logfile_write <span class="s2">&quot;(mongo) End compilation </span><span class="nv">$msg_head</span><span class="s2">: </span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> 1

  <span class="k">return</span> 0

<span class="o">}</span>
</pre></div>
</div>
</div></div>
<div class="section" id="commons-mongo-compile-all-idxs">
<span id="commons-mongo-compile-all-idxs"></span><h3>commons_mongo_compile_all_idxs<a class="headerlink" href="#commons-mongo-compile-all-idxs" title="Permalink to this headline">¶</a></h3>
<p>Compile all files under <code class="docutils literal"><span class="pre">$MONGO_DIR</span></code>/indexes directory.</p>
<p><em>Parameters</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$1</span></code>: (msg) message to insert on logging file relative to input file.</li>
<li><code class="docutils literal"><span class="pre">$2</span></code>: (force) if equals to 1, force compilation of all indexes also
if already present.</li>
</ul>
<p><em>Returns</em>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>: on success</li>
<li><code class="docutils literal"><span class="pre">1</span></code>: on error</li>
</ul>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return
        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock184'))">(Show/Hide)</a><br /><div id="hiddencodeblock184" style="display: none"><div class="highlight-bash"><div class="highlight"><pre><span></span>commons_mongo_compile_all_idxs <span class="o">()</span> <span class="o">{</span>

  <span class="nb">local</span> <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">local</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MONGO_DIR</span><span class="s2">/indexes&quot;</span>

  commons_mongo_compile_all_from_dir <span class="s2">&quot;</span><span class="nv">$directory</span><span class="s2">&quot;</span> <span class="s2">&quot;of all indexes&quot;</span> <span class="s2">&quot;</span><span class="nv">$msg</span><span class="s2">&quot;</span> <span class="s2">&quot;idx&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">force</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
    <span class="k">return</span> 1

  <span class="k">return</span> 0
<span class="o">}</span>
</pre></div>
</div>
</div></div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Geaaru.<br/>
      Last updated on Jan 06, 2018.<br/>
    </p>
  </div>
</footer>
  </body>
</html>